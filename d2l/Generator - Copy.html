<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brightspace Test Question Generator</title>
    <!-- Style sheet -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/bbTools.css?v=2">
    <link rel="stylesheet" href="css/popup.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
</head>

<body>
    <div id="wrapper">
        <div id="topbar">
            <div id="topbar-inner">
                <div class="svg-container">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
                        <!-- SVG symbols here (unchanged from original) -->
                    </svg>
                </div>
                <svg viewBox="0 0 100 100" class="topbar__logo">
                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#cu-shield-outlined"></use>
                    <title>Carleton University</title>
                    <desc>Carleton University shield</desc>
                </svg>
                
                <h2 class="topbar__h2">Brightspace Quiz Question Generator</h2>
            </div>
        </div>
        
        <div id="body">
            <h1>Test/Quiz Question Generator</h1>
            <p>This Algonquin College developed Quiz Question Generator provides an easy way of creating a collection of questions that can be imported into Brightspace quizzes and pools, saving you time in the process!</p>
            
            <h2>Instructions</h2>
            <ol>
                <li>All questions must follow a proper format for the generator to recognize them.</li>
                <li>Select the Question Type Samples dropdown and click Create to see a sample question. Refer to the <a href="help/QuestionTypes.pdf" target="_blank" rel="noopener noreferrer">Question&nbsp;Types&nbsp;document</a> for how to properly format your questions.</li>                                   
                <li>Copy and paste all your questions from a word document or type them out in the box below.</li>
                <li>Click <strong>Generate Test Questions.</strong></li>
                <ul>
                    <li>In case the Test Generator fails, review the questions in red. It could mean the format is not correct or something is missing.</li>
                </ul>
                <li>Once the generation has passed, click the <strong>Download Questions for Brightspace</strong> button at the bottom of the page.</li>
                <li>Save the .csv file to your computer.</li>
                <li>In the Add/Edit Questions screen in Brightspace, use the Import option and upload the .csv file. Follow the prompts.</li>
                <li>Refer to <a href="https://carleton.ca/brightspace/instructors/using-the-brightspace-quiz-question-generator/#sect2" target="_blank" rel="noopener noreferrer">Importing Quiz Questions into Brightspace.</a> for more info.</li>
            </ol>
            <p><a href="https://carleton.ca/brightspace/instructors/using-the-brightspace-quiz-question-generator/" target="_blank" rel="noopener noreferrer">Click here to view the full instructions</a></p>
                            
            <hr>
            
            <div class="form-container">
                <div class="form-row">
                    <div class="form-group">
                        <label for="txtQuizName"><strong>QUIZ NAME</strong></label>
                        <input name="txtQuizName" type="text" id="txtQuizName">
                    </div>
                    
                    <div class="form-group">
                        <label for="sampleQuestionTypes"><strong>QUESTION TYPE SAMPLES</strong></label>
                        <select name="sampleQuestionTypes" id="sampleQuestionTypes">
                            <option value="0">Multiple Choice</option>
                            <option value="1">Multiple Answer</option>
                            <option value="2">True or False</option>
                            <option value="3">Essay/Written Response</option>
                            <option value="4">Short Answer</option>
                            <option value="5">Matching</option>
                            <option value="6">Ordering</option>
                        </select>
                        <button onclick="addQuestion()" class="myButton">CREATE</button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div id="error-message" class="error-message" style="display:none;">
                        <strong><span id="lblError">Test generation failed<br/>Hold your mouse cursor over any red box for more information<br /></span></strong>
                    </div>
                </div>
                
                <div class="form-row">
                    <div id="panelQuiz">
                        <textarea name="quiz" rows="2" cols="20" id="quiz"></textarea>
                    </div>
                </div>
                
                <div class="form-row button-row">
                    <button onclick="generateQuestions()" class="myButton">Generate Test Questions</button>
                    <button onclick="clearQuestions()" class="myButton">Clear Test Questions</button>
                </div>
            </div>
            
            <div id="panelDownload" class="download-panel" style="display:none;">
                <div class="download-content">
                    <button onclick="downloadQuestions()" class="myButton download-button">Download Test Questions for Brightspace</button>
                    <div id="lblDownload" class="download-info">Test Generated with 9 Questions</div>
                </div>
            </div>
        </div>
        
        <div id="footer">
            <div id="footer-inner">
                <p>For questions about this Quiz Question Generator, please contact Teaching &amp; Learning Support: <a href="mailto:tlssupport@cunet.carleton.ca">tlssupport@cunet.carleton.ca</a></p>
                <p>Reused with permission from Algonquin College.<br>
                Algonquin College &copy; 2012</p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // question templates
        const txtMultipleChoice = "1. Which of the following is a prime number?\na) 4\n*b) 5\nc) 6";
        const txtMultipleAnswer = "1. Which of the following is a prime number?\n*a) 2\n*b) 3\nd) 4\n*e) 5\nf) 6\n*g) 7";
        const txtTrueFalse = "1. 3 is a prime number.\nTrue";
        const txtEssay = "1. Tell me your life story.";
        const txtShort = "short 1. Two plus two equals _____.\na. four\nb. 4";
        const txtMatching = "match 1. Match the number with its spelling.\na. 3 / three\nb. 1 / one\nc. 12 / twelve\nd. / fore";
        const txtOrdering = "order 1. Ordering the following planets according to distance from the sun, shortest to longest.\nMercury\nEarth\nMars\nJupiter\nNeptune";

        let allQuestions = "";
        let numQuestions = 0;
        let csvFile = "";
        let error = false;
        let qIndex = 0;
        let errorList = [];
        let errorIndexes = [];
        let questionsArray = [];

        // add question to quiz from default drop down list
        function addQuestion() {
            const questionList = document.getElementById("sampleQuestionTypes");
            const selectedQuestion = questionList.value;
            const quizTextarea = document.getElementById("quiz");

            let questionToAdd = "";
            switch(selectedQuestion) {
                case "0": questionToAdd = txtMultipleChoice; break;
                case "1": questionToAdd = txtMultipleAnswer; break;
                case "2": questionToAdd = txtTrueFalse; break;
                case "3": questionToAdd = txtEssay; break;
                case "4": questionToAdd = txtShort; break;
                case "5": questionToAdd = txtMatching; break;
                case "6": questionToAdd = txtOrdering; break;
            }

            // Add the question with spacing if needed
            if (quizTextarea.value && !quizTextarea.value.endsWith("\n\n")) {
                quizTextarea.value += "\n\n";
            }
            quizTextarea.value += questionToAdd + "\n\n";

            // remove old textareas if they exists
            for(let i = 0; i < numQuestions; i++) {
                const element = document.getElementById("question" + i);
                if (element) {
                    element.remove();
                }
            }
            
            numQuestions = 0;
            document.getElementById("panelDownload").style.display = "none";
            document.getElementById("lblError").style.display = "none";
            document.getElementById("quiz").style.display = "block";
            questionsArray = []; // remove old questions
        }

        // reset quiz
        function clearQuestions() {
            document.getElementById("quiz").value = "";
            document.getElementById("panelDownload").style.display = "none";
            document.getElementById("quiz").style.display = "block";
            document.getElementById("lblError").style.display = "none";
            questionsArray = []; // remove old questions

            // remove old textareas if they exists
            for(let i = 0; i < numQuestions; i++) {
                const element = document.getElementById("question" + i);
                if (element) {
                    element.remove();
                }
            }
            numQuestions = 0;
        }

        // check questions and create quiz file to download
        function generateQuestions() {
            document.getElementById("panelDownload").style.display = "none";
            csvFile = ""; // start new csv file
            error = false; // reset error
            errorList = []; 
            errorIndexes = [];

            const quizTextarea = document.getElementById("quiz");

            if (numQuestions === 0) { // first time generating/checking questions
                allQuestions = quizTextarea.value;
                allQuestions = fixLastQuestion(allQuestions); // add "\n\n" of last question if not there
                questionsArray = allQuestions.split('\n\n'); // split into individual questions
                numQuestions = questionsArray.length - 1; // don't count empty element at end
            } else {
                quizTextarea.value = "";
                for(qIndex = 0; qIndex < numQuestions; qIndex++) {
                    questionsArray[qIndex] = document.getElementById("question" + qIndex).value; // update questions array from each question textarea
                }
            }

            document.getElementById("lblDownload").innerHTML = "Test Generated with " + numQuestions + " Questions<br />";

            quizTextarea.value = "";
            allQuestions = "";
            
            for(qIndex = 0; qIndex < numQuestions; qIndex++) { // check type of each question
                checkQuestion(questionsArray[qIndex]);
                
                const element = document.getElementById("question" + qIndex); // remove old textarea if it already exists
                if (element) {
                    element.remove();
                }

                // create individual textarea for each question
                document.getElementById("panelQuiz").innerHTML += `
                    <textarea name="question${qIndex}" rows="2" cols="20" id="question${qIndex}" 
                        title="Valid question." style="background-color:#C8FFC8;height:75px;width:98%;">
                        ${questionsArray[qIndex]}
                    </textarea>`;
            }

            if(error) { // update question textareas if they have errors
                document.getElementById("lblError").style.display = "block";
                for(let m = 0; m < errorIndexes.length; m++) {
                    const questionElement = document.getElementById("question" + errorIndexes[m]);
                    questionElement.style.backgroundColor = "#FFC8C8";
                    questionElement.title = errorList[m]; // error to show on mouse hover
                }
            } else { // no errors
                document.getElementById("panelDownload").style.display = "block";
                document.getElementById("lblError").style.display = "none";
            }
            
            quizTextarea.style.display = "none";
            quizTextarea.value = allQuestions; // update quiz form
        }

        // check the question type and validity
        function checkQuestion(question) {
            const lines = question.split("\n"); // get each line of the question
            const numLines = lines.length;

            for(let h = 0; h < numLines; h++) { // remove white space from start and end of each line
                lines[h] = lines[h].trim();    
                allQuestions += lines[h] + "\n"; // reassemble questions string for quiz form
            }
            allQuestions += "\n"; // extra line feed at end of question, question seperator
            
            const questionREGEX = /^[0-9]{1,3}\.(?=.*[a-zA-Z]).+/; // check for question formatting, i.e. "1. what is next?" is correct
            const isQuestion = questionREGEX.test(lines[0]);
            const isKeyword = questionREGEX.test(lines[0].substring(6,lines[0].length)); // check for question formatting, i.e. "short 1. what is next ___" is correct
            
            if (isQuestion) { // standard question valid
                if (numLines === 1) { // essay question
                    essay(lines[0]); // write to csv file
                } else if (numLines === 2) { // true/false
                    if (lines[1].toLowerCase() === "true" || lines[1].toLowerCase() === "false") {
                        trueFalse(question); // write to csv file
                    } else {
                        recordError("Only one answer was found and it was not true or false", qIndex);
                    }
                } else if (numLines > 2) { // multiple choice or multiple answer
                    const answer1REGEX = /^[a-zA-Z]\)[a-zA-Z0-9\s]/; // starts with "a)"
                    const answer2REGEX = /^\*[a-zA-Z]\)[a-zA-Z0-9\s]/; // starts with "*a)"
                    
                    for(let y = 1; y < numLines; y++) {
                        const test1 = answer1REGEX.test(lines[y]);
                        const test2 = answer2REGEX.test(lines[y]);

                        if (test1 === false && test2 === false) {
                            recordError("This question has an invalid answer: " + lines[y], qIndex); 
                            return; // exit checkQuestion() function on error
                        } 
                    }
                    
                    // check if one right answer or multiple right answers
                    let count = 0;
                    for(let z = 1; z < numLines; z++) { // start at second line
                        if (lines[z].indexOf("*") === 0) {
                            count++;
                        }
                    }

                    if (count === 0) {
                        recordError("No correct answers were found for this question.", qIndex); 
                    } else if (count === 1) { // multiple choice
                        multipleChoice(question); // write to csv file
                    } else if (count > 1) { // multiple answer
                        multipleAnswer(question); // write to csv file
                    }
                }
            } else if (questionREGEX.test(lines[0].substring(6,lines[0].length))) { // check question after keyword short, order, match
                const keyword = lines[0].substring(0,5).toLowerCase();
                const shortREGEX = /^[a-zA-Z]\.[a-zA-Z0-9\s]/; // starts with "a."
                const matchREGEX = /^[a-zA-Z]\.[a-zA-Z0-9\s]+\/[a-zA-Z0-9\s]+/; // starts with "a." and contains "/"

                if (keyword === "order") {
                    ordering(question);
                } else if (numLines > 1) {
                    if (keyword === "short" || keyword === "blank") { // Short answer & old "blank" keyword
                        for(let j = 1; j < numLines; j++) {
                            if (!shortREGEX.test(lines[j])) { // check answer starts with "a."
                                recordError("This question has an invalid answer: " + lines[j], qIndex); 
                                return; // exit checkQuestion() function on error
                            } 
                        }
                        shortAnswer(question); // write to csv file
                    } else if (keyword === "match") { // matching
                        for(let n = 1; n < numLines; n++) {
                            if (!matchREGEX.test(lines[n])) { // check answer starts with "a." and contains "/"
                                recordError("This question has an invalid answer: " + lines[n], qIndex); 
                                return; // exit checkQuestion() function on error
                            } 
                        }
                        matching(question); // write to csv file
                    }
                } else {
                    recordError("This question has no answer.", qIndex); 
                }
            } else if (lines[0].length === 2 && numLines > 1) { // alternative methods for question creation
                const altQuestion = lines[0].toLowerCase();

                if (altQuestion === "bl" || altQuestion === "mc" || altQuestion === "ma") {
                    if (numLines === 2) {
                        recordError("Question requires at least one answer.", qIndex); 
                    } else if (numLines > 2) {
                        if (altQuestion === "bl") {
                            shortAnswerAlternative(question); // write to csv file
                        } else {
                            // check if atleast one right answer
                            let count2 = 0;
                            for(let k = 2; k < numLines; k++) { // start at 3rd
                                if (lines[k].indexOf("*") === 0) {
                                    count2++;
                                }
                            }

                            if (count2 === 0) {
                                if (altQuestion === "bl") {
                                    recordError("Short answer questions must have at least one answer.", qIndex); 
                                } else {
                                    recordError("Question requires at least one correct answer.", qIndex); 
                                }
                            } else {
                                if (altQuestion === "mc") {
                                    multipleChoiceAlternative(question); // write to csv file
                                } else if (altQuestion === "ma") {
                                    multipleAnswerAlternative(question); // write to csv file
                                }
                            }
                        }
                    }
                }
            } else { // incorrect question format
                recordError("No question present.", qIndex); 
            } 
        }

        // keep track of questions with errors
        function recordError(errorText, errorIndex) {
            errorList.push(errorText);
            errorIndexes.push(errorIndex);
            error = true;
        }

        // adds "\n" to end of text (last question) for splitting of questions into array
        function fixLastQuestion(aQ) {
            const last = aQ.substring(aQ.length - 1, aQ.length);
            const secLast = aQ.substring(aQ.length - 2, aQ.length - 1);

            if (last !== "\n") {
                aQ = aQ + "\n";
            }
            
            if (secLast !== "\n") {
                aQ = aQ + "\n";
            }

            return aQ;
        }
        
        // true/file csv
        function trueFalse(tfQuestion) {
            const tfLines = tfQuestion.split("\n"); // get each line of the question
            const tfQ = tfQuestion.substring((tfLines[0].indexOf(".") + 2, tfLines[0].length);
            let t, f;
            
            if (tfLines[1].toLowerCase() === "true") {
                t = "100";
                f = "0";
            } else {
                t = "0";
                f = "100";
            }
            
            const tfCSV = "NewQuestion,TF,\n" +
                        "QuestionText,\"" + tfQ + "\",\n" +
                        "TRUE," + t + "\n" +
                        "FALSE," + f + "\n\n";
            csvFile += tfCSV;
        }

        // essay csv
        function essay(eQuestion) {
            const eQ = eQuestion.substring((eQuestion.indexOf(".") + 2, eQuestion.length);
            const eCSV = "NewQuestion,WR,\n" +
                        "QuestionText,\"" + eQ + "\",\n" +
                        "AnswerKey, ,\n\n";
            csvFile += eCSV;
        }

        // ordering csv
        function ordering(oQuestion) {
            const oLines = oQuestion.split("\n"); // get each line of the question
            const numOLines = oLines.length;
            const oQ = oLines[0].substring((oLines[0].indexOf(".") + 2, oLines[0].length);
            let oCSV = "NewQuestion,O,\n" +
                      "QuestionText,\"" + oQ + "\",\n";

            for(let x = 1; x < numOLines; x++) { // add items to order
                oCSV += "Item,\"" + oLines[x] + "\",\n";
            }
            oCSV += "\n";
            csvFile += oCSV;
        }

        // multiple choice csv
        function multipleChoice(mcQuestion) {
            const mcLines = mcQuestion.split("\n"); // get each line of the question
            const numMCLines = mcLines.length;
            const mcQ = mcLines[0].substring((mcLines[0].indexOf(".") + 1, mcLines[0].length).trim();
            let mcCSV = "NewQuestion,MC,\n" +
                       "QuestionText,\"" + mcQ + "\",\n";
            
            for(let w = 1; w < numMCLines; w++) {
                const mcA = mcLines[w].substring((mcLines[w].indexOf(")") + 1, mcLines[w].length).trim();
                if (mcLines[w].indexOf("*") === 0) {
                    mcCSV += "Option,100,\"" + mcA + "\",\n"; // correct answer
                } else {
                    mcCSV += "Option,0,\"" + mcA + "\",\n"; // incorrect answer
                }
            }
            mcCSV += "\n";
            csvFile += mcCSV;
        }

        // multiple choice alternative method csv
        function multipleChoiceAlternative(mcaQuestion) {
            const mcaLines = mcaQuestion.split("\n"); // get each line of the question
            const numMCALines = mcaLines.length;
            const mcaQ = mcaLines[1].trim();
            let mcaCSV = "NewQuestion,MC,\n" +
                         "QuestionText,\"" + mcaQ + "\",\n";
            
            for(let r = 2; r < numMCALines; r++) {
                const mcaA = mcaLines[r].substring((mcaLines[r].indexOf("*") + 1, mcaLines[r].length).trim();
                if (mcaLines[r].indexOf("*") === 0) {
                    mcaCSV += "Option,100,\"" + mcaA + "\",\n"; // correct answer
                } else {
                    mcaCSV += "Option,0,\"" + mcaA + "\",\n"; // incorrect answer
                }
            }
            mcaCSV += "\n";
            csvFile += mcaCSV;
        }

        // multiple answer csv
        function multipleAnswer(maQuestion) {
            const maLines = maQuestion.split("\n"); // get each line of the question
            const numMALines = maLines.length;
            const maQ = maLines[0].substring((maLines[0].indexOf(".") + 1, maLines[0].length).trim();
            let maCSV = "NewQuestion,MS,\n" +
                       "QuestionText,\"" + maQ + "\",\n";
            
            for(let u = 1; u < numMALines; u++) {
                const maA = maLines[u].substring((maLines[u].indexOf(")") + 1, maLines[u].length).trim();
                if (maLines[u].indexOf("*") === 0) {
                    maCSV += "Option,1,\"" + maA + "\",\n"; // correct answer
                } else {
                    maCSV += "Option,0,\"" + maA + "\",\n"; // incorrect answer
                }
            }
            maCSV += "\n";
            csvFile += maCSV;
        }

        // multiple answer alternative method csv
        function multipleAnswerAlternative(maaQuestion) {
            const maaLines = maaQuestion.split("\n"); // get each line of the question
            const numMAALines = maaLines.length;
            const maaQ = maaLines[1].trim();
            let maaCSV = "NewQuestion,MS,\n" +
                         "QuestionText,\"" + maaQ + "\",\n";
            
            for(let g = 2; g < numMAALines; g++) {
                const maaA = maaLines[g].substring((maaLines[g].indexOf("*") + 1, maaLines[g].length).trim();
                if (maaLines[g].indexOf("*") === 0) {
                    maaCSV += "Option,1,\"" + maaA + "\",\n"; // correct answer
                } else {
                    maaCSV += "Option,0,\"" + maaA + "\",\n"; // incorrect answer
                }
            }
            maaCSV += "\n";
            csvFile += maaCSV;
        }

        // matching csv
        function matching(mQuestion) {
            const mLines = mQuestion.split("\n"); // get each line of the question
            const numMLines = mLines.length;
            const mQ = mLines[0].substring((mLines[0].indexOf(".") + 1, mLines[0].length).trim();
            let mCSV = "NewQuestion,M,\n" +
                       "QuestionText,\"" + mQ + "\",\n";

            for(let v = 1; v < numMLines; v++) {
                const choice = mLines[v].substring((mLines[v].indexOf(".") + 1, mLines[v].indexOf("/")).trim();
                const match = mLines[v].substring((mLines[v].indexOf("/") + 1, mLines[v].length).trim();
                if (choice !== "") {
                    mCSV += "Choice,\"" + v + "\",\"" + choice + "\",\n";
                }
                mCSV += "Match,\"" + v + "\",\"" + match + "\",\n";
            }
            mCSV += "\n";
            csvFile += mCSV;
        }

        // Short answer csv
        function shortAnswer(bQuestion) {
            const bLines = bQuestion.split("\n"); // get each line of the question
            const numBLines = bLines.length;
            const bQ = bLines[0].substring((bLines[0].indexOf(".") + 1, bLines[0].length).trim();
            let bCSV = "NewQuestion,SA,\n" +
                       "QuestionText,\"" + bQ + "\",\n";
            for(let t = 1; t < numBLines; t++) {
                const bAnswer = bLines[t].substring((bLines[t].indexOf(".") + 1, bLines[t].length).trim();
                bCSV += "Answer,100,\"" + bAnswer + "\",\n";
            }
            bCSV += "\n";
            csvFile += bCSV;
        }

        // Short answer alternative method csv
        function shortAnswerAlternative(baQuestion) {
            const baLines = baQuestion.split("\n"); // get each line of the question
            const numBALines = baLines.length;
            const baQ = baLines[1].trim();
            let baCSV = "NewQuestion,SA,\n" +
                        "QuestionText,\"" + baQ + "\",\n";
            for(let s = 2; s < numBALines; s++) {
                const baAnswer = baLines[s].substring((baLines[s].indexOf(".") + 1, baLines[s].length).trim();
                baCSV += "Answer,100,\"" + baAnswer + "\",\n";
            }
            baCSV += "\n";
            csvFile += baCSV;
        }

        // download brightspace csv document
        function downloadQuestions() {
            document.getElementById("panelDownload").style.display = "none";

            let filename = document.getElementById("txtQuizName").value;
            if (filename === "") {
                filename = "brightspaceQuiz.csv";
            } else {
                filename = filename.replace(/\s/g, "") + ".csv";
            }
            
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(csvFile));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }
    </script>
</body>
</html>