<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="#">
    <title>..::Amir's Coin Collection::..</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* General Styles */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --accent-light: #f39c12;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --text-color: #2c3e50;
            --text-light: #f8f9fa;
            --border-color: #dfe6e9;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --gold-color: #FFD700;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #dfe6e9 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .out-container {
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
        }

        .inner-container {
            width: 90%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .title {
            margin: 20px 0;
            font-size: 28px;
            font-weight: 700;
            color: var(--secondary-color);
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        .main-content {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: space-between;
            margin-top: 20px;
        }

        /* Search Bar */
        .search-container {
            width: 100%;
            max-width: 600px;
            margin: 20px 0;
            position: relative;
        }

        .search-bar {
            width: 100%;
            padding: 12px 20px;
            padding-left: 45px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }

        .search-results {
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 100;
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .search-result-item:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Gallery Section */
        .gallery-section {
            flex: 1;
            min-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .current-img-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: white;
            position: relative;
            padding: 15px;
            gap: 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .current-img-container img {
            max-width: 100%;
            height: 300px;
            object-fit: contain;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
            cursor: pointer;
        }

        .current-img-container img:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .img-queue {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .img-queue-in {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px;
            width: 100%;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #f1f1f1;
        }

        .img-queue-in::-webkit-scrollbar {
            height: 6px;
        }

        .img-queue-in::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .img-queue-in::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        .img-queue-in img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            border-radius: 4px;
        }

        .img-queue-in img:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        .img-queue-in img.active-thumbnail {
            border: 3px solid var(--accent-color);
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
            transform: scale(1.1);
        }

        /* Map Section */
        .map-section {
            flex: 1;
            min-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        /* Continent Map Section */
        .continent-map-container {
            display: none;
            width: 100%;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .continent-map-container.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .continent-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .continent-info-item {
            display: flex;
            flex-direction: column;
        }

        .continent-info-label {
            font-size: 12px;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .continent-info-value {
            font-size: 14px;
            font-weight: 600;
        }

        #continent-map {
            width: 100%;
            height: 200px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        /* Continent highlight styles */
        .continent-highlight {
            fill-opacity: 0.7;
            stroke-width: 2;
            stroke: #e74c3c;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                fill-opacity: 0.7;
            }

            50% {
                fill-opacity: 0.4;
            }

            100% {
                fill-opacity: 0.7;
            }
        }

        /* Marker icon for country location */
        .continent-country-marker {
            background: transparent;
            border: none;
        }

        /* Flag image style */
        .country-flag {
            width: 70px;
            /* Same width as thumbnail */
            height: 70px;
            /* Same height as thumbnail */
            object-fit: contain;
            /* Ensure the flag fits without cropping */
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: var(--transition);
        }

        .country-flag:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        /* Countries List */
        .countries-list {
            width: 100%;
            padding: 25px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 30px;
            border: 1px solid var(--border-color);
        }

        .countries-list h2 {
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .countries-list h2 .country-name {
            color: var(--accent-color);
            font-weight: 600;
        }

        .countries-list ul {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            padding: 0;
            list-style: none;
        }

        .countries-list a {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            height: 40px;
            background: var(--light-color);
            border-radius: var(--border-radius);
            color: var(--text-color);
            text-decoration: none;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            padding: 0 15px;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .countries-list a:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);
            border-color: var(--primary-dark);
        }

        .countries-list a.active {
            background: var(--accent-color);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.2);
            border-color: var(--accent-color);
        }

        /* Buttons */
        .btn {
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--primary-dark);
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-nav {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            padding: 0;
        }

        /* Home Button Wrapper for Summary Pop-up */
        .home-button-wrapper {
            position: relative;
            /* Needed for absolute positioning of summary */
            display: inline-block;
            /* To make the wrapper only as wide as its content */
            margin-bottom: 15px;
            /* Maintain original spacing */
        }

        .btn-home {
            background: var(--secondary-color);
            border-color: var(--dark-color);
            color: white;
            position: relative;
            /* Ensure z-index works */
            z-index: 2;
            /* Keep button above summary */
        }

        .btn-home i {
            color: white;
        }

        .btn-home:hover {
            background: var(--dark-color);
        }

        /* Details Section */
        .details-section {
            width: 100%;
            margin-top: 15px;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .details-toggle {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--dark-color);
        }

        .details-toggle:hover {
            background: var(--dark-color);
        }

        .details-toggle span {
            color: var(--gold-color);
        }

        .details-toggle i.fa-info-circle {
            color: var(--gold-color);
            margin-right: 8px;
        }

        .details-toggle i.fa-chevron-down {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            color: white;
        }

        .details-toggle.collapsed i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .details-content {
            padding: 20px;
            background: white;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            border: 1px solid var(--border-color);
            border-top: none;
            margin-top: -1px;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .details-content.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }



        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }


        /* additional */
        /* FIXED: Improved mobile text display for detail items */
        .detail-item {
            flex-direction: column;
            gap: 5px;
            width: 100%;
            overflow: hidden;
            /* Prevent overflow */
        }

        .detail-label {
            min-width: auto;
            font-size: 14px;
            width: 100%;
        }

        .detail-value {
            font-size: 16px;
            line-height: 1.4;
            width: 100%;
            overflow: hidden;
            /* Prevent overflow */
        }

        /* Ensure text doesn't overflow in modal details */
        .modal-details p,
        .flag-modal-details p {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Fix for the visual scale container on mobile */
        @media (max-width: 900px) {
            .size-scale-container {
                max-width: 100% !important;
                width: 100% !important;
            }
        }

        /* end additional */


        /* Image Modal - UPDATED FOR CONSISTENT SIZING */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            overflow: auto;
            animation: fadeInModal 0.3s;
        }

        @keyframes fadeInModal {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            padding: 20px;
            position: relative;
        }

        .modal-image {
            max-width: 90%;
            max-height: 70vh;
            width: auto;
            height: auto;
            object-fit: contain;
            object-position: center;
            animation: zoomIn 0.3s;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* Ensure consistent sizing for all image types */
        .modal-image[src*="coin"],
        .modal-image[src*="bill"],
        .modal-image[src*="paper"],
        .modal-image[src*="antique"] {
            max-width: 500px;
            max-height: 500px;
            width: auto;
            height: auto;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.9);
            }

            to {
                transform: scale(1);
            }
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            z-index: 1001;
        }

        .close-modal:hover {
            color: var(--accent-color);
            transform: rotate(90deg);
        }

        /* Modal Nav Buttons */
        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            transition: background 0.3s ease;
            z-index: 1001;
        }

        .modal-nav:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        #prev-modal-btn {
            left: 20px;
        }

        #next-modal-btn {
            right: 20px;
        }

        /* Modal Details */
        .modal-details {
            margin-top: 15px;
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            max-width: 80%;
            width: 100%;
        }



        .modal-details p strong {
            color: var(--gold-color);
        }

        /* Flag Modal */
        .flag-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            overflow: auto;
            animation: fadeInModal 0.3s;
        }

        .flag-modal-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            padding: 20px;
        }

        .flag-modal-image {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            animation: zoomIn 0.3s;
        }

        .close-flag-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-flag-modal:hover {
            color: var(--accent-color);
            transform: rotate(90deg);
        }

        /* Flag Modal Details */
        .flag-modal-details {
            margin-top: 15px;
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: var(--border-radius);
        }



        .flag-modal-details p strong {
            color: var(--gold-color);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .gallery-section,
            .map-section {
                min-width: 100%;
            }

            .current-img-container img {
                height: 250px;
            }

            .btn-nav {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            /* Updated modal styles for mobile */
            .modal-image {
                max-width: 95%;
                max-height: 60vh;
                padding: 15px;
            }

            .modal-image[src*="coin"],
            .modal-image[src*="bill"],
            .modal-image[src*="paper"],
            .modal-image[src*="antique"] {
                max-width: 350px;
                max-height: 350px;
            }

            .modal-details {
                max-width: 95%;
                font-size: 13px;
            }

            .flag-modal-image {
                max-width: 95%;
                max-height: 70vh;
            }

            /* Adjust summary for smaller screens */
            .summary {
                width: 200px;
                /* Even smaller on mobile */
                padding: 8px 12px;
            }

            .summary p {
                font-size: 11px;
            }

            .summary i {
                font-size: 14px;
                margin-right: 6px;
                width: 16px;
            }

            /* FIXED: Improved mobile text display for detail items */
            .detail-item {
                flex-direction: column;
                gap: 5px;
            }

            .detail-label {
                min-width: auto;
                font-size: 14px;
            }

            .detail-value {
                font-size: 16px;
                line-height: 1.4;
            }
        }

        /* Footer */
        footer {
            width: 80vw;
            margin-top: 60px;
            text-align: center;
            font-size: 1.1em;
            color: var(--secondary-color);
            padding: 20px 40px;
            margin-left: auto;
            margin-right: auto;
        }

        footer a {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition);
        }

        footer a:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        /* Summary Section - Updated for Pop-up */
        .summary {
            position: absolute;
            top: calc(100% + 10px);
            /* Position below the home button with a gap */
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            /* Fixed smaller width */
            padding: 10px 15px;
            background-color: var(--secondary-color);
            color: var(--text-light);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 10;
            /* Ensure it appears above other elements */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            text-align: left;
            /* Align text within summary */
        }

        /* Triangle "arrow" pointing up from the summary to the button */
        .summary::before {
            content: '';
            position: absolute;
            bottom: 100%;
            /* Position above the summary box */
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px;
            border-style: solid;
            border-color: transparent transparent var(--secondary-color) transparent;
        }

        /* Show summary on hover of the wrapper */
        .home-button-wrapper:hover .summary {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
            /* Slight lift effect */
        }

        .summary p {
            margin: 5px 0;
            /* Reduced margin */
            display: flex;
            align-items: center;
            font-size: 13px;
            /* Smaller font size */
            color: var(--text-light);
            /* Ensure text color is light */
        }

        .summary i {
            margin-right: 8px;
            /* Reduced margin */
            color: var(--gold-color);
            width: 18px;
            /* Smaller icon size */
            text-align: center;
            font-size: 16px;
            /* Smaller icon font size */
        }

        /* New styles for the selected country name and count */
        .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .main-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--secondary-color);
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        .selected-country-title {
            font-size: 24px;
            font-weight: 600;
            color: #4CAF50;
            /* Green color for the country name */
            text-align: center;
            margin-top: 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* --- NEW FEATURES STYLES --- */

        /* Gallery View Section */
        .gallery-view-section {
            width: 100%;
            display: none;
            /* Initially hidden */
            flex-direction: column;
            gap: 20px;
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        .gallery-view-section.show {
            display: flex;
            /* Show when 'show' class is added */
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 10px;
            justify-content: center;
        }

        .gallery-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--light-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .gallery-item-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            object-position: center;
            transition: transform 0.3s ease;
        }

        .gallery-item-image:hover {
            transform: scale(1.05);
        }

        .gallery-item-info {
            padding: 10px;
            text-align: center;
            width: 100%;
        }

        .gallery-item-info p {
            font-size: 12px;
            color: var(--secondary-color);
            margin: 0;
            font-weight: 500;
        }

        /* Sorting and Filtering */
        .filter-sort-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-sort-container select,
        .filter-sort-container label {
            font-size: 14px;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .filter-sort-container select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-sort-container select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Back to Top Button */
        #back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--box-shadow);
            opacity: 0;
            /* Initially hidden */
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            z-index: 999;
        }

        #back-to-top.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #back-to-top:hover {
            background: var(--primary-dark);
            transform: translateY(-5px);
        }

        /* Gallery/Slider View Toggle */
        .view-toggle-container {
            display: flex;
            justify-content: flex-end;
            width: 100%;
            max-width: 1400px;
            margin: 10px auto;
        }

        .view-toggle-container button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .view-toggle-container button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        .view-toggle-container button.active {
            background-color: var(--accent-color);
        }

        /* URL Modal for Note links */
        #url-modal {
            display: none;
            position: fixed;
            z-index: 2500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
        }

        #url-modal .url-modal-content {
            background: #fff;
            margin: 4% auto;
            padding: 0;
            border-radius: 10px;
            width: min(1000px, 92%);
            height: 84%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #url-modal iframe {
            flex: 1;
            border: none;
            width: 100%;
        }

        #url-modal .close-url-modal {
            align-self: flex-end;
            font-size: 28px;
            font-weight: bold;
            color: #333;
            padding: 6px 14px;
            cursor: pointer;
        }

        #url-modal .close-url-modal:hover {
            color: #c00;
        }

        .note-url-link {
            word-break: break-word;
            /* break URLs if too long */
            overflow-wrap: anywhere;
            display: inline-block;
            max-width: 100%;
        }

        .country-tooltip {
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            font-weight: 600;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* Style for country details section */
        .country-details {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .country-details .continent-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
            background-color: transparent;
            border: none;
        }

        .country-details .continent-info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .country-details .continent-info-label {
            font-size: 12px;
            color: var(--secondary-color);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .country-details .continent-info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-dark);
        }

        /* Responsive adjustments for country details */
        @media (max-width: 900px) {
            .country-details .continent-info {
                flex-direction: column;
                gap: 10px;
            }

            .country-details .continent-info-item {
                flex-direction: row;
                justify-content: space-between;
                width: 100%;
            }
        }

        /* Add these styles to your CSS section */
        .area-comparison {
            margin-top: 15px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .comparison-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comparison-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .comparison-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .comparison-bar {
            width: 100%;
        }

        .comparison-bar-background {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .comparison-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-light));
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        .comparison-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 11px;
            color: var(--secondary-color);
        }

        .comparison-labels span:nth-child(2) {
            font-weight: 600;
            color: var(--primary-dark);
        }

        /* Responsive adjustments for comparison */
        @media (max-width: 900px) {
            .comparison-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .comparison-labels {
                flex-direction: column;
                gap: 3px;
            }

            .comparison-labels span {
                text-align: center;
            }
        }
    </style>

    <style>
        /* Space Optimization Adjustments */

        /* Reduce vertical spacing throughout */
        .out-container {
            padding: 15px 10px;
            /* Reduced from 20px */
        }

        .inner-container {
            width: 95%;
            /* Increased from 90% */
            margin-bottom: 15px;
            /* Reduced from 20px */
        }

        .title-container {
            margin: 15px 0;
            /* Reduced from 20px */
        }

        .main-title {
            font-size: 26px;
            /* Slightly smaller */
            margin-bottom: 5px;
        }

        .selected-country-title {
            font-size: 22px;
            /* Slightly smaller */
        }

        /* Search bar adjustments */
        .search-container {
            margin: 15px 0;
            /* Reduced from 20px */
            max-width: 500px;
            /* Slightly smaller */
        }

        /* Main content area optimization */
        .main-content {
            gap: 20px;
            /* Reduced from 30px */
            margin-top: 15px;
            /* Reduced from 20px */
        }

        .gallery-section,
        .map-section {
            padding: 20px;
            /* Reduced from 25px */
            min-width: 350px;
            /* Reduced from 400px */
        }

        /* Image container adjustments */
        .current-img-container {
            padding: 12px;
            /* Reduced from 15px */
            gap: 12px;
            /* Reduced from 15px */
        }

        .current-img-container img {
            height: 280px;
            /* Reduced from 300px */
        }

        /* Thumbnail adjustments */
        .img-queue-in img {
            width: 65px;
            /* Reduced from 70px */
            height: 65px;
            /* Reduced from 70px */
        }

        /* Map height adjustment */
        #map {
            height: 380px;
            /* Reduced from 400px */
        }

        /* Continent info adjustments */
        .continent-info {
            padding: 8px 10px;
            /* Reduced from 10px */
        }

        .continent-info-label {
            font-size: 11px;
            /* Slightly smaller */
        }

        .continent-info-value {
            font-size: 13px;
            /* Slightly smaller */
        }

        #continent-map {
            height: 180px;
            /* Reduced from 200px */
        }

        .country-flag {
            width: 65px;
            /* Reduced from 70px */
            height: 65px;
            /* Reduced from 70px */
        }

        /* Countries list optimization */
        .countries-list {
            padding: 20px;
            /* Reduced from 25px */
            margin-top: 25px;
            /* Reduced from 30px */
        }

        .countries-list h2 {
            margin-bottom: 15px;
            /* Reduced from 20px */
            font-size: 20px;
            /* Reduced from 22px */
        }

        .countries-list a {
            min-width: 110px;
            /* Reduced from 120px */
            height: 38px;
            /* Reduced from 40px */
            font-size: 13px;
            /* Reduced from 14px */
            padding: 0 12px;
            /* Reduced from 15px */
        }

        /* Button adjustments */
        .btn {
            padding: 10px 18px;
            /* Reduced from 12px 20px */
            font-size: 15px;
            /* Reduced from 16px */
        }

        .btn-nav {
            width: 45px;
            /* Reduced from 50px */
            height: 45px;
            /* Reduced from 50px */
            font-size: 18px;
            /* Reduced from 20px */
        }

        /* Details section optimization */
        .details-toggle {
            padding: 12px 18px;
            /* Reduced from 14px 20px */
            font-size: 14px;
            /* Reduced from 15px */
        }

        .details-content {
            padding: 18px;
            /* Reduced from 20px */
        }

        /* Gallery view optimization */
        .gallery-view-section {
            padding: 20px;
            /* Reduced from 25px */
        }

        .gallery-grid {
            gap: 12px;
            /* Reduced from 15px */
            padding: 8px;
            /* Reduced from 10px */
        }

        .gallery-item-image {
            height: 140px;
            /* Reduced from 150px */
        }

        /* Filter/sort container */
        .filter-sort-container {
            gap: 12px;
            /* Reduced from 15px */
            margin-bottom: 15px;
            /* Reduced from 20px */
        }

        /* Footer optimization */
        footer {
            margin-top: 40px;
            /* Reduced from 60px */
            padding: 15px 30px;
            /* Reduced from 20px 40px */
            font-size: 1em;
            /* Reduced from 1.1em */
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 900px) {
            .out-container {
                padding: 10px 5px;
            }

            .gallery-section,
            .map-section {
                min-width: 100%;
                padding: 15px;
            }

            .current-img-container img {
                height: 240px;
                /* Reduced from 250px */
            }

            .btn-nav {
                width: 40px;
                /* Reduced from 40px (no change but keeping for consistency) */
                height: 40px;
                /* Reduced from 40px (no change but keeping for consistency) */
            }

            #map {
                height: 340px;
                /* Reduced from 400px on mobile */
            }

            #continent-map {
                height: 160px;
                /* Reduced from 200px on mobile */
            }

            .countries-list {
                padding: 15px;
                margin-top: 20px;
            }

            .countries-list a {
                min-width: 100px;
                height: 36px;
                font-size: 12px;
            }
        }

        /* Additional space savings for very small screens */
        @media (max-width: 480px) {
            .title-container {
                margin: 10px 0;
            }

            .main-title {
                font-size: 22px;
            }

            .selected-country-title {
                font-size: 18px;
            }

            .search-container {
                margin: 10px 0;
            }

            .gallery-section,
            .map-section {
                padding: 12px;
            }

            .current-img-container {
                padding: 8px;
            }

            .current-img-container img {
                height: 200px;
            }

            .img-queue-in img {
                width: 55px;
                height: 55px;
            }

            #map {
                height: 300px;
            }

            .countries-list {
                padding: 12px;
            }

            .countries-list a {
                min-width: 90px;
                height: 34px;
                font-size: 11px;
                padding: 0 8px;
            }
        }

        /* Fix for the home button wrapper to prevent extra space */
        .home-button-wrapper {
            margin-bottom: 10px;
            /* Reduced from 15px */
        }

        /* Ensure summary popup doesn't create extra space */
        .summary {
            top: calc(100% + 8px);
            /* Reduced from 10px */
        }

        /* View toggle container optimization */
        .view-toggle-container {
            margin: 8px auto;
            /* Reduced from 10px */
        }

        .view-toggle-container button {
            padding: 7px 12px;
            /* Reduced from 8px 15px */
            font-size: 13px;
            /* Reduced from 14px */
        }

        /* Back to top button size reduction */
        #back-to-top {
            width: 45px;
            /* Reduced from 50px */
            height: 45px;
            /* Reduced from 50px */
            font-size: 22px;
            /* Reduced from 24px */
            bottom: 25px;
            /* Reduced from 30px */
            right: 25px;
            /* Reduced from 30px */
        }
    </style>
    <style>
        /* Add these styles to your CSS section */

        .size-scale-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 300px;
            overflow: visible;
        }

        .size-scale {
            height: 30px;
            background-color: #e9ecef;
            border-radius: 4px;
            position: relative;
            margin-bottom: 15px;
            overflow: visible;
            width: 100%;
        }

        .scale-item {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-light));
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: width 0.5s ease;
            min-width: 40px;
        }

        .two-dimensional-scale {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
            overflow: visible;
        }

        .scale-rectangle {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-light));
            border: 2px solid var(--primary-dark);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            max-width: 100%;
            overflow: visible;
        }

        .scale-dimensions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 12px;
            color: var(--secondary-color);
            text-align: center;
            width: 100%;
            overflow: visible;
        }

        .dimension.width::before {
            content: "→ ";
            color: var(--primary-color);
        }

        .dimension.height::before {
            content: "↓ ";
            color: var(--accent-color);
        }

        .scale-label {
            color: white;
            font-weight: 600;
            font-size: 11px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            padding: 0 4px;
            overflow: visible;
            text-overflow: clip;
            max-width: 100%;
            box-sizing: border-box;
        }

        .scale-reference {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
            width: 100%;
            overflow: visible;
        }

        .reference-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            overflow: visible;
            flex-wrap: wrap;
            /* Allow wrapping on small screens */
        }

        .reference-line-container {
            display: flex;
            align-items: center;
            min-width: 60px;
            /* Ensure minimum space for the line */
            flex-grow: 1;
        }

        .reference-line {
            height: 4px;
            border-radius: 2px;
            flex-shrink: 0;
            min-width: 10px;
            max-width: 100%;
        }

        .reference-rectangle {
            border: 1px solid var(--secondary-color);
            border-radius: 2px;
            flex-shrink: 0;
            min-width: 10px;
            max-width: 100%;
            overflow: visible;
        }

        /* Different colors for each reference line */
        .reference-line.penny {
            background-color: #e74c3c;
        }

        .reference-line.quarter {
            background-color: #3498db;
        }

        .reference-line.dollar-coin {
            background-color: #f39c12;
        }

        .reference-rectangle.dollar-bill {
            background-color: #27ae60;
            height: 12px;
        }

        .reference-label {
            font-size: 11px;
            color: var(--secondary-color);
            white-space: nowrap;
            min-width: 110px;
            overflow: visible;
            text-overflow: clip;
            flex-shrink: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 900px) {
            .size-scale-container {
                max-width: 100%;
            }

            .size-scale {
                height: 25px;
            }

            .scale-label {
                font-size: 10px;
            }

            .reference-label {
                font-size: 10px;
                min-width: 100px;
            }

            .reference-rectangle.dollar-bill {
                height: 10px;
            }

            .scale-dimensions {
                font-size: 10px;
            }

            /* Mobile layout improvements */
            .reference-item {
                flex-direction: row;
                align-items: center;
                gap: 6px;
            }

            .reference-line-container {
                min-width: 40px;
                /* Smaller minimum on mobile */
            }

            .reference-label {
                min-width: 90px;
            }
        }

        /* For very small screens */
        @media (max-width: 480px) {
            .reference-label {
                font-size: 9px;
                min-width: 80px;
            }

            .reference-item {
                gap: 4px;
            }

            .reference-line-container {
                min-width: 30px;
                /* Even smaller on very small screens */
            }
        }

        /* Box List Button Styles */
        .box-list-button-wrapper {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .btn-box-list {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            background: var(--secondary-color);
            border-color: var(--dark-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-box-list i {
            color: white;
            font-size: 18px;
        }

        .btn-box-list:hover {
            background: var(--dark-color);
            transform: translateY(-2px);
        }

        /* Responsive adjustment */
        @media (max-width: 900px) {
            .box-list-button-wrapper {
                top: 15px;
                right: 15px;
            }

            .btn-box-list {
                width: 35px;
                height: 35px;
            }

            .btn-box-list i {
                font-size: 16px;
            }
        }

        .home-button-wrapper {
            margin-bottom: 10px;
            position: relative;
            z-index: 101;
            /* Ensure it stays above the box list button */
        }
    </style>
    <style>
        /* Timeline Visualization Styles */
        .timeline-section {
            width: 100%;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            display: none;
        }

        .timeline-section.show {
            display: block;
        }

        .timeline-container {
            width: 100%;
            height: 120px;
            position: relative;
            margin-top: 10px;
        }

        .timeline-axis {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--secondary-color);
        }

        .timeline-marker {
            position: absolute;
            bottom: 0;
            width: 6px;
            height: 20px;
            background-color: var(--primary-color);
            transform: translateX(-50%);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 2px;
        }

        .timeline-marker:hover {
            height: 30px;
            background-color: var(--accent-color);
        }

        .timeline-marker.active {
            height: 40px;
            background-color: var(--accent-color);
            z-index: 10;
        }

        .timeline-label {
            position: absolute;
            bottom: -25px;
            font-size: 10px;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        .timeline-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            bottom: 25px;
            transform: translateX(-50%);
            white-space: nowrap;
            display: none;
            z-index: 100;
        }

        .timeline-marker:hover .timeline-tooltip {
            display: block;
        }

        .timeline-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timeline-stats {
            font-size: 14px;
            color: var(--secondary-color);
        }
    </style>
    <style>
        /* Currency Distribution Styles */
        .distribution-section {
            width: 100%;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            display: none;
        }

        .distribution-section.show {
            display: block;
        }

        .distribution-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }

        .distribution-chart {
            width: 200px;
            height: 200px;
            position: relative;
        }

        .distribution-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .distribution-title {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Add this to your CSS section */
        .detail-item.year-additional {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #e0e0e0;
        }

        .detail-item.year-additional .detail-label {
            font-weight: 500;
            /* Slightly lighter than the first year */
        }

        .detail-item.year-additional .detail-value {
            font-size: 15px;
            /* Slightly smaller than the first year */
        }


        /* Enhanced Timeline Styles */
        .timeline-year-container {
            min-width: 30px;
        }

        .timeline-bar-container {
            gap: 1px;
        }

        .timeline-bar {
            position: relative;
            transition: all 0.3s ease;
        }

        .timeline-bar:hover {
            transform: scale(1.15);
            z-index: 20;
        }

        .timeline-bar:hover .timeline-tooltip {
            display: block;
            opacity: 1;
        }

        .timeline-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 100;
            pointer-events: none;
        }

        .timeline-bar:hover::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid #e74c3c;
            border-radius: 4px;
            z-index: -1;
        }

        /* Timeline stats enhancement */
        .timeline-stats {
            font-size: 13px;
            color: #7f8c8d;
            font-weight: 500;
        }

        /* Color legend for currency types */
        .timeline-color-legend {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Responsive adjustments */
        @media (max-width: 900px) {
            .timeline-bar {
                width: 16px;
            }

            .timeline-year-container {
                min-width: 25px;
            }

            .timeline-tooltip {
                font-size: 10px;
                padding: 3px 6px;
            }
        }


        /* Enhanced Timeline Styles */
        .timeline-year-container {
            min-width: 30px;
        }

        .timeline-bar-container {
            gap: 1px;
        }

        .timeline-bar {
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .timeline-bar:hover {
            transform: scale(1.15);
            z-index: 20;
            filter: brightness(1.2);
        }

        .timeline-bar:hover .timeline-tooltip {
            display: block;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .timeline-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            display: none;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 100;
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            text-align: center;
            line-height: 1.4;
        }

        .timeline-tooltip strong {
            color: #f39c12;
            display: block;
            margin-bottom: 2px;
        }

        .timeline-bar.active {
            box-shadow: 0 0 0 3px #e74c3c, 0 0 10px rgba(231, 76, 60, 0.5) !important;
            border: 2px solid white !important;
            z-index: 30;
        }

        /* Timeline stats enhancement */
        .timeline-stats {
            font-size: 13px;
            color: #7f8c8d;
            font-weight: 500;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        /* Color legend for currency types */
        .timeline-color-legend {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        /* Year count badge for stacked bars */
        .year-count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Responsive adjustments */
        @media (max-width: 900px) {
            .timeline-bar {
                width: 16px;
            }

            .timeline-year-container {
                min-width: 25px;
            }

            .timeline-tooltip {
                font-size: 10px;
                padding: 6px 8px;
                white-space: normal;
                max-width: 120px;
                word-wrap: break-word;
            }

            .timeline-color-legend {
                gap: 10px;
            }

            .legend-item {
                font-size: 11px;
            }
        }

        /* Interactive Distribution Chart Styles */
        .distribution-chart {
            position: relative;
            cursor: pointer;
        }

        .distribution-chart::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }

        .distribution-chart:hover::before {
            border-color: var(--primary-color);
        }

        .legend-item:hover {
            transform: translateX(5px);
            opacity: 1 !important;
        }

        .legend-item:hover .legend-color {
            transform: scale(1.1);
        }

        .legend-color {
            transition: all 0.3s ease;
        }

        /* Active filter state */
        .distribution-filter-active {
            box-shadow: 0 0 0 3px var(--accent-color);
        }


        /* Enhanced Interactive Distribution Chart Styles */
        .distribution-chart {
            position: relative;
            cursor: pointer;
            margin: 0 auto;
        }

        .chart-segment-overlay {
            transition: all 0.3s ease;
        }

        .chart-segment-overlay:hover {
            opacity: 0.1 !important;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            background: white;
        }

        .legend-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .legend-item.active {
            border-color: var(--primary-color);
            background-color: #e3f2fd;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 12px;
            transition: all 0.3s ease;
        }

        .legend-item:hover .legend-color {
            transform: scale(1.1);
        }

        .distribution-legend {
            max-width: 300px;
            margin: 0 auto;
        }

        /* Center text styles */
        .distribution-chart .center-text {
            pointer-events: none;
        }

        /* Donor highlight styles */
        .donor-highlight {
            background-color: #33a2ec;/*#fff3cd;*/
            border: 1px solid #33a2ec;/*#ffeaa7;*/
            border-radius: 4px;
            padding: 8px 12px;
            margin: 5px 0;
            font-weight: 600;
            color: #856404;
        }

        .donor-highlight .detail-label {
            color: #856404;
            font-weight: 700;
        }

        .donor-highlight .detail-value {
            color: #180ad8;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="out-container">
        <div class="inner-container">
            <div class="home-button-wrapper">
                <a href="index.html" class="btn btn-home"><i class="fas fa-home"></i> Home</a>
                <div id="summary-container" class="summary"></div>
            </div>
            <div class="box-list-button-wrapper">
                <a href="box_country_list.html" class="btn btn-box-list" title="Box Country List" target="_blank">
                    <i class="fas fa-boxes"></i>
                </a>
            </div>

            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" class="search-bar" placeholder="Search for a country..."
                    autocomplete="off">
                <div id="search-results" class="search-results"></div>
            </div>

            <h1 id="image-caption" class="title-container">
                <span class="main-title">Amir's Coin Collection</span>
                <span id="selected-country-title" class="selected-country-title"></span>
            </h1>

            <div class="view-toggle-container">
                <button id="toggle-view-btn" class="btn"><i class="fas fa-th"></i> Grid View</button>
            </div>

            <div class="main-content" id="main-content">
                <div class="gallery-section" id="slider-view">
                    <div class="slider-container">
                        <button id="prev-btn" class="btn btn-nav"><i class="fas fa-chevron-left"></i></button>
                        <div class="slider">
                            <div class="current-img-container">
                                <img id="current-image-img" src="placeholder.jpg" alt="Loading..." />
                            </div>
                            <div class="details-section">
                                <button class="details-toggle">
                                    <span><i class="fas fa-info-circle"></i> Coin Details</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="details-content" id="current-image-note"></div>
                            </div>
                        </div>
                        <button id="next-btn" class="btn btn-nav"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="img-queue">
                        <div class="img-queue-in" id="thumbnail-container"></div>
                    </div>
                </div>

                <div class="map-section">
                    <div id="map"></div>
                    <div class="continent-map-container" id="continent-map-container">
                        <div class="continent-info">
                            <div class="continent-info-item">
                                <span class="continent-info-label">Continent</span>
                                <span class="continent-info-value" id="continent-name">--</span>
                            </div>
                            <div class="continent-info-item">
                                <span class="continent-info-label">Country</span>
                                <span class="continent-info-value" id="continent-country-name">--</span>
                            </div>
                            <div class="continent-info-item">
                                <span class="continent-info-label">Capital</span>
                                <span class="continent-info-value" id="continent-capital">--</span>
                            </div>
                        </div>
                        <div id="continent-map"></div>
                        <img id="country-flag" class="country-flag" src="" alt="Country Flag" style="display:none;">
                        <!-- Add this after the flag image in the continent-map-container -->
                        <!-- Replace the country-details section with this updated version -->
                        <div class="country-details" id="country-details" style="display: none;">
                            <div class="continent-info">
                                <div class="continent-info-item">
                                    <span class="continent-info-label">Area</span>
                                    <span class="continent-info-value" id="country-area">--</span>
                                </div>
                                <div class="continent-info-item">
                                    <span class="continent-info-label">Population</span>
                                    <span class="continent-info-value" id="country-population">--</span>
                                </div>
                                <div class="continent-info-item">
                                    <span class="continent-info-label">Region</span>
                                    <span class="continent-info-value" id="country-region">--</span>
                                </div>
                            </div>
                            <!-- Add this comparison section -->
                            <div class="area-comparison" id="area-comparison" style="display: none;">
                                <div class="comparison-info">
                                    <span class="comparison-label">Size compared to USA:</span>
                                    <span class="comparison-value" id="usa-comparison">--</span>
                                </div>
                                <div class="comparison-bar">
                                    <div class="comparison-bar-background">
                                        <div class="comparison-bar-fill" id="comparison-bar-fill"></div>
                                    </div>
                                    <div class="comparison-labels">
                                        <span>0%</span>
                                        <span>USA Size</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="gallery-view-section" id="gallery-view">
                <div class="filter-sort-container">
                    <div>
                        <label for="sort-by">Sort by:</label>
                        <select id="sort-by">
                            <option value="name-asc">A-Z</option>
                            <option value="name-desc">Z-A</option>
                            <option value="type">Type</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-by">Filter by:</label>
                        <select id="filter-by">
                            <option value="all">All</option>
                            <option value="coin">Coins</option>
                            <option value="paper-bill">Paper Bills</option>
                            <option value="antique">Antique</option>
                        </select>
                    </div>
                </div>
                <div class="gallery-grid" id="gallery-grid-container">
                </div>
            </div>

            <div class="countries-list" id="countries-list">
                <h2>
                    <i class="fas fa-globe-americas"></i>
                    <span>Available Countries</span>
                    <span id="total-countries-count"></span>
                    <span id="selected-country" class="country-name"></span>
                </h2>
                <ul id="countries-ul"></ul>
            </div>
            <!-- Add this after the countries-list section -->
            <div class="timeline-section" id="timeline-section">
                <div class="timeline-title">
                    <h3><i class="fas fa-history"></i> Collection Timeline</h3>
                    <div class="timeline-stats" id="timeline-stats"></div>
                </div>
                <div class="timeline-container" id="timeline-container"></div>
            </div>
            <!-- Add this after the timeline section -->
            <div class="distribution-section" id="distribution-section">
                <div class="distribution-title">
                    <h3><i class="fas fa-chart-pie"></i> Currency Type Distribution</h3>
                </div>
                <div class="distribution-container" id="distribution-container"></div>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <span class="close-modal">&times;</span>
        <div class="modal-content">
            <button id="prev-modal-btn" class="modal-nav"><i class="fas fa-chevron-left"></i></button>
            <img id="modalImage" class="modal-image" src="" alt="Enlarged view">
            <button id="next-modal-btn" class="modal-nav"><i class="fas fa-chevron-right"></i></button>
            <div class="modal-details" id="image-modal-details" style="display: none;">
                <p><strong>Country:</strong> <span id="modal-country-name"></span></p>
                <p><strong>Capital:</strong> <span id="modal-capital-name"></span></p>
                <p><strong>Currency:</strong> <span id="modal-currency-name"></span></p>
                <p><strong>Note:</strong> <span id="modal-note"></span></p>
            </div>
        </div>
    </div>

    <div id="flagModal" class="flag-modal">
        <span class="close-flag-modal">&times;</span>
        <div class="flag-modal-content">
            <img id="flagModalImage" class="flag-modal-image" src="" alt="Enlarged flag view">
            <div class="flag-modal-details" id="flag-modal-details" style="display: none;">
                <p><strong>Country:</strong> <span id="flag-country-name"></span></p>
                <p><strong>Continent:</strong> <span id="flag-continent-name"></span></p>
            </div>
        </div>
    </div>

    <!-- URL Modal -->
    <div id="url-modal">
        <div class="url-modal-content">
            <span class="close-url-modal">&times;</span>
            <iframe id="url-modal-iframe" src="about:blank"></iframe>
        </div>
    </div>



    <button id="back-to-top" title="Go to top"><i class="fas fa-arrow-up"></i></button>


    <footer>
        <p><i class="far fa-copyright"></i> 2025 Amiruzzaman coin collection. All rights reserved. |
            <a href="privacy.html" target="_blank"><i class="fas fa-lock"></i> Privacy Policy</a>
        </p>
    </footer>

    <script>
        // Global variables for caching fetched data to improve performance
        const cache = {
            coinsData: null,
            countriesData: null,
            continentData: null,
            countryGeoJsonMapping: null,
            continentGeoJson: null
        };

        let currentCountryCoins = []; // Store the coins for the currently selected country
        let currentImageIndex = 0; // To keep track of the current image index for modal navigation

        // Global map instances to prevent re-initialization
        let mainMap = null;
        let continentMap = null;
        let mainMapGeoJsonLayer = null; // Layer for highlighted country on main map
        let availableCountriesLayer = null; // Layer for all available countries on main map
        let continentMapGeoJsonLayer = null; // Layer for highlighted continent on continent map
        let continentMapMarker = null; // Marker for country on continent map

        // Utility function to convert string to Title Case
        function toTitleCase(str) {
            return str.replace(/\w\S*/g, txt => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
        }
        // Fetch and process data
        fetch('images/coins.json')
            .then(response => response.json())
            .then(data => {
                // First filter out entries with invalid images
                const validData = data.filter(coin =>
                    coin.image && coin.image.trim() !== "" && coin.image.toLowerCase() !== "none"
                );

                originalData = combineData(validData);
                //console.log(originalData);
                renderSummary(originalData, validData.length);
            })
            .catch(error => console.error('Error fetching JSON:', error));

        // Combine duplicate countries
        function combineData(data) {
            const result = [];
            data.forEach(item => {
                // Check if the country already exists in the result
                let existing = result.find(entry => entry.country === item.country);
                if (existing) {
                    // Merge unique donor names
                    const donorNames = new Set(existing.donor_name.split(', ').concat(item.donor_name.split(', ')));
                    existing.donor_name = Array.from(donorNames).join(', ');

                    // Merge unique currency types
                    const currencyTypes = new Set(existing.currency_type.split(', ').concat(item.currency_type.split(', ')));
                    existing.currency_type = Array.from(currencyTypes).join(', ');
                } else {
                    // Add new country entry
                    result.push({ ...item });
                }
            });
            return result;
        }


        // Render the summary
        function renderSummary(data, n) {
            const summary = document.getElementById('summary-container');
            const numCountries = new Set(data.map(item => item.country)).size;
            const totalVariations = n; // Total number of JSON objects
            let numPaperBills = 0;
            let numCoins = 0;
            let numAntique = 0;

            data.forEach(item => {
                item.currency_type.split(', ').forEach(type => {
                    const normalizedType = type.toLowerCase();
                    if (normalizedType.includes('paper-bill')) numPaperBills++;
                    if (normalizedType.includes('coin')) numCoins++;
                    if (normalizedType.includes('antique')) numAntique++;
                });
            });

            summary.innerHTML = `
        <p><i class="fas fa-globe-americas"></i> Countries: ${numCountries}</p>
        <p><i class="fas fa-cubes"></i> Variations: ${totalVariations}</p>
        <p><i class="fas fa-money-bill-alt"></i> Bills: ${numPaperBills}</p>
        <p><i class="fas fa-coins"></i> Coins: ${numCoins}</p>
        <p><i class="fas fa-clock"></i> Antique: ${numAntique}</p>
    `;
        }

        // helper to clean values
        function cleanValue(val) {
            if (!val || val.toString().trim().toLowerCase() === "none") {
                return "N/A";
            }
            return val;
        }

        // helper function
        function safeVal(val) {
            if (!val) return "N/A";
            if (typeof val === "string" && val.trim().toLowerCase() === "none") return "N/A";
            return val;
        }
        // Update the preloadData function to include the new countries.details.json
        async function preloadData() {
            try {
                const [coinsData, countriesData, continentData, countryGeoJsonMapping, continentGeoJson, languagesData, countriesDetails] = await Promise.all([
                    fetch("images/coins.json").then(res => res.json()),
                    fetch("countries.json").then(res => res.json()),
                    fetch("countries.continents.json").then(res => res.json()),
                    fetch("geojson/country_geojson_mapping.json").then(res => res.json()),
                    fetch("continents.geojson").then(res => res.json()),
                    fetch("countries.languages.json").then(res => res.json()),
                    fetch("countries.details.json").then(res => res.json()) // NEW: Load country details https://www.apicountries.com/countries
                ]);

                cache.coinsData = coinsData;
                cache.countriesData = countriesData;
                cache.continentData = continentData;
                cache.countryGeoJsonMapping = countryGeoJsonMapping;
                cache.continentGeoJson = continentGeoJson;
                cache.languagesData = languagesData;
                cache.countriesDetails = countriesDetails; // NEW: Store country details

                console.log("All data preloaded successfully.");
                return true;
            } catch (error) {
                console.error("Error preloading data:", error);
                return false;
            }
        }


        // Sets the current image in the gallery and updates its details
        async function setCurrentImage(src, note, donor, currency_type, countryInfo, year, size, index) {
            const image = document.getElementById("current-image-img");
            const noteElement = document.getElementById("current-image-note");
            const countryFlagElement = document.getElementById("country-flag");

            currentImageIndex = index;

            // Use a temporary image to preload and ensure smooth transition
            const tempImage = new Image();
            tempImage.onload = () => {
                image.setAttribute("src", src);
                document.getElementById("modalImage").setAttribute("src", src);
            };
            tempImage.onerror = () => {
                // Fallback to a placeholder if image fails to load
                image.setAttribute("src", "https://placehold.co/300x200/cccccc/333333?text=Image+Not+Found");
                document.getElementById("modalImage").setAttribute("src", "https://placehold.co/600x400/cccccc/333333?text=Image+Not+Found");
                console.error(`Failed to load image: ${src}`);
            };
            tempImage.src = src; // Start loading the image

            // Get alphabet example from countries.languages.json
            let alphabetExample = "N/A";
            if (cache.languagesData) {
                const langMatch = cache.languagesData.find(c => {
                    return c.country_name.toLowerCase() === countryInfo.name.toLowerCase();
                });

                if (langMatch && langMatch.languages[0].alphabet_example) {
                    alphabetExample = langMatch.languages[0].alphabet_example;
                }
            }

            // Parse year values - handle single or multiple years
            let yearDisplay = "";
            if (year) {
                // Split by comma and trim each value
                const years = year.split(',').map(y => y.trim());

                years.forEach((yearValue, idx) => {
                    const yearNum = parseInt(yearValue);
                    if (!isNaN(yearNum) && yearNum > 1000 && yearNum <= new Date().getFullYear()) {
                        const age = new Date().getFullYear() - yearNum;
                        yearDisplay += `<div class="detail-item${idx > 0 ? ' year-additional' : ''}">
                    <span class="detail-label"><strong>${idx === 0 ? 'Year' : 'Year'}:</strong></span>
                    <span class="detail-value">
                        ${yearValue} <span style="color: #3498db;">(${age} years old)</span>
                    </span>
                </div>`;
                    } else if (yearValue) {
                        // For non-numeric or invalid years, just display the value
                        yearDisplay += `<div class="detail-item${idx > 0 ? ' year-additional' : ''}">
                    <span class="detail-label"><strong>${idx === 0 ? 'Year' : 'Year'}:</strong></span>
                    <span class="detail-value">${yearValue}</span>
                </div>`;
                    }
                });

                // If no valid years were processed, show N/A
                if (!yearDisplay) {
                    yearDisplay = `<div class="detail-item">
                <span class="detail-label"><strong>Year:</strong></span>
                <span class="detail-value">N/A</span>
            </div>`;
                }
            } else {
                yearDisplay = `<div class="detail-item">
            <span class="detail-label"><strong>Year:</strong></span>
            <span class="detail-value">N/A</span>
        </div>`;
            }

            // Use percentage-based scaling instead of fixed pixels
            const maxVisualWidth = 280;

            // Parse size correctly, handling both single values and width x height formats
            let sizeValue1 = 0;
            let sizeValue2 = 0;
            let isTwoDimensional = false;
            let displaySize = "N/A";

            if (size) {
                if (size.includes('x')) {
                    const sizeParts = size.split('x').map(part => parseFloat(part.trim()));
                    if (sizeParts.length === 2 && !isNaN(sizeParts[0]) && !isNaN(sizeParts[1])) {
                        sizeValue1 = sizeParts[0];
                        sizeValue2 = sizeParts[1];
                        isTwoDimensional = true;
                        displaySize = `${sizeValue1 % 1 === 0 ? sizeValue1 : sizeValue1.toFixed(1)} × ${sizeValue2 % 1 === 0 ? sizeValue2 : sizeValue2.toFixed(1)}`;
                    }
                } else {
                    sizeValue1 = parseFloat(size);
                    if (!isNaN(sizeValue1)) {
                        displaySize = sizeValue1 % 1 === 0 ? sizeValue1 : sizeValue1.toFixed(1);
                    }
                }
            }

            // Calculate relative sizes as percentages of max width
            const maxItemSize = Math.max(sizeValue1, sizeValue2, 30.6);
            const scalePercentage1 = !isNaN(sizeValue1) ? (sizeValue1 / maxItemSize) * 100 : 0;
            const scalePercentage2 = !isNaN(sizeValue2) ? (sizeValue2 / maxItemSize) * 100 : 0;

            // Reference sizes as percentages
            const pennyPercentage = (19 / maxItemSize) * 100;
            const quarterPercentage = (24.3 / maxItemSize) * 100;
            const dollarCoinPercentage = (30.6 / maxItemSize) * 100;
            const dollarBillWidthPercentage = (66.3 / maxItemSize) * 100;
            const dollarBillHeightPercentage = (156 / maxItemSize) * 100;

            // Construct the HTML for coin details with visual scale
            const countryDetails = countryInfo ? `
    <div class="detail-item">
        <span class="detail-label"><strong>Country:</strong></span>
        <span class="detail-value">${safeVal(countryInfo.name)}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label"><strong>Capital:</strong></span>
        <span class="detail-value">${safeVal(countryInfo.capital)}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label"><strong>Language:</strong></span>
        <span class="detail-value">${safeVal(countryInfo.language?.name)}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label"><strong>Hello:</strong></span>
        <span class="detail-value">${alphabetExample}</span>
    </div>
    <div class="detail-item">
        <span class="detail-label"><strong>Currency:</strong></span>
        <span class="detail-value">${safeVal(countryInfo.currency?.name)} (${safeVal(countryInfo.currency?.symbol)})</span>
    </div>
    <div class="detail-item">
        <span class="detail-label"><strong>Note:</strong></span>
        <span class="detail-value">${formatNoteWithURLs(safeVal(note) || "No note available")}</span>
    </div>
    ${yearDisplay}
    <div class="detail-item">
        <span class="detail-label"><strong>Size:</strong></span>
        <span class="detail-value">
        ${size
                    ? `${displaySize} <span style="color: #3498db;"> mm${isTwoDimensional ? ' (W × H)' : ''}</span>`
                    : "N/A"}
        </span>
    </div>
    ${size && !isNaN(sizeValue1) ? `
    <div class="detail-item">
        <span class="detail-label"><strong>Visual Scale:</strong></span>
        <span class="detail-value">
            <div class="size-scale-container">
                ${isTwoDimensional ? `
                <div class="two-dimensional-scale">
                    <div class="scale-rectangle" style="width: ${scalePercentage1}%; height: ${scalePercentage2 / 2}%;">
                        <span class="scale-label"><strong>${displaySize} mm</strong></span>
                    </div>
                    <div class="scale-dimensions">
                        <span class="dimension width"><strong>${sizeValue1 % 1 === 0 ? sizeValue1 : sizeValue1.toFixed(1)} mm width</strong></span>
                        <span class="dimension height"><strong>${sizeValue2 % 1 === 0 ? sizeValue2 : sizeValue2.toFixed(1)} mm height</strong></span>
                    </div>
                </div>
                ` : `
                <div class="size-scale">
                    <div class="scale-item" style="width: ${scalePercentage1}%;">
                        <span class="scale-label"><strong>${displaySize} mm</strong></span>
                    </div>
                </div>
                `}
                <div class="scale-reference">
                    <div class="reference-item">
                        <div class="reference-line penny" style="width: ${pennyPercentage}%;"></div>
                        <span class="reference-label"><strong>US Penny (19 mm)</strong></span>
                    </div>
                    <div class="reference-item">
                        <div class="reference-line quarter" style="width: ${quarterPercentage}%;"></div>
                        <span class="reference-label"><strong>US Quarter (24.3 mm)</strong></span>
                    </div>
                    <div class="reference-item">
                        <div class="reference-line dollar-coin" style="width: ${dollarCoinPercentage}%;"></div>
                        <span class="reference-label"><strong>US Dollar Coin (30.6 mm)</strong></span>
                    </div>
                    <div class="reference-item">
                        <div class="reference-rectangle dollar-bill" style="width: ${dollarBillHeightPercentage / 3}%; height: ${dollarBillWidthPercentage}%;"></div>
                        <span class="reference-label"><strong>US Dollar Bill (156 × 66.3 mm)</strong></span>
                    </div>
                </div>
            </div>
        </span>
    </div>
    ` : ''}
    <div class="detail-item donor-highlight">
        <span class="detail-label"><strong>Donor (${safeVal(currency_type) || "--"}):</strong></span>
        <span class="detail-value">${safeVal(donor) || "Unknown"}</span>
    </div>
` : `<div class="detail-item">
        <span class="detail-value">Country information not available.</span>
    </div>`;

            noteElement.innerHTML = countryDetails;

            // Load continent map data and flag if country info is available
            if (countryInfo && countryInfo.name) {
                await loadContinentData(countryInfo.name);
            } else {
                // Hide flag if no country info
                countryFlagElement.style.display = 'none';
                countryFlagElement.src = '';
            }
        }


        // Loads continent-specific data and updates the continent info display
        // Update the loadContinentData function to include country details
        // Update the loadContinentData function to include USA comparison
        // Add debug logging to loadContinentData
        async function loadContinentData(countryName) {
            try {
                console.log("Loading continent data for:", countryName);

                if (!cache.continentData) {
                    console.error("Continent data not loaded from cache.");
                    return;
                }

                const countryData = cache.continentData.countries.country.find(c =>
                    c.countryName.toLowerCase() === countryName.toLowerCase()
                );

                //console.log("Found country data:", countryData);

                const countryFlagElement = document.getElementById("country-flag");
                const countryDetailsElement = document.getElementById("country-details");
                const areaComparisonElement = document.getElementById("area-comparison");

                if (countryData) {
                    const continentName = countryData.continentName;
                    const countryDisplayName = countryData.countryName;
                    const capital = countryData.capital;
                    const countryCode = countryData.countryCode;

                    console.log("Setting continent info:", continentName, countryDisplayName, capital);

                    document.getElementById('continent-name').textContent = continentName;
                    document.getElementById('continent-country-name').textContent = countryDisplayName;
                    document.getElementById('continent-capital').textContent = capital;

                    // Update Flag Modal details
                    document.getElementById('flag-country-name').textContent = countryDisplayName;
                    document.getElementById('flag-continent-name').textContent = continentName;

                    await loadContinentMap(continentName, countryDisplayName);

                    // Display the country flag
                    if (countryCode) {
                        const flagSrc = `flags/svg/${countryCode.toLowerCase()}.svg`;
                        countryFlagElement.src = flagSrc;
                        countryFlagElement.style.display = 'block';
                        countryFlagElement.onerror = () => {
                            countryFlagElement.style.display = 'none';
                            console.warn(`Flag not found for country code: ${countryCode}`);
                        };

                        // Add click event to the flag to open modal
                        countryFlagElement.onclick = () => {
                            openFlagModal(flagSrc);
                        };
                    } else {
                        countryFlagElement.style.display = 'none';
                    }

                    // NEW: Load and display additional country details
                    if (cache.countriesDetails) {
                        console.log("Countries details available:", cache.countriesDetails.length, "countries");

                        const countryDetails = cache.countriesDetails.find(c =>
                            c.name.toLowerCase() === countryDisplayName.toLowerCase()
                        );

                        //console.log("Found country details:", countryDetails);

                        if (countryDetails) {
                            // Format area with commas and add unit
                            const areaFormatted = countryDetails.area ?
                                countryDetails.area.toLocaleString() + ' km²' : 'N/A';

                            // Format population with commas
                            const populationFormatted = countryDetails.population ?
                                countryDetails.population.toLocaleString() : 'N/A';

                            document.getElementById('country-area').textContent = areaFormatted;
                            document.getElementById('country-population').textContent = populationFormatted;
                            document.getElementById('country-region').textContent =
                                countryDetails.region || 'N/A';

                            // Show the details container
                            countryDetailsElement.style.display = 'block';

                            // Calculate and display USA comparison
                            if (countryDetails.area) {
                                // Find USA area for comparison
                                const usaDetails = cache.countriesDetails.find(c =>
                                    c.name.toLowerCase() === "united states of america"
                                );

                                if (usaDetails && usaDetails.area) {
                                    const usaArea = usaDetails.area;
                                    const countryArea = countryDetails.area;
                                    const comparisonPercentage = (countryArea / usaArea) * 100;

                                    let comparisonText;
                                    if (comparisonPercentage < 1) {
                                        comparisonText = `${comparisonPercentage.toFixed(1)}% of USA`;
                                    } else if (comparisonPercentage < 100) {
                                        comparisonText = `${comparisonPercentage.toFixed(1)}% of USA`;
                                    } else {
                                        comparisonText = `${(comparisonPercentage / 100).toFixed(1)}× USA`;
                                    }

                                    document.getElementById('usa-comparison').textContent = comparisonText;

                                    // Animate the comparison bar
                                    setTimeout(() => {
                                        const barFill = document.getElementById('comparison-bar-fill');
                                        // Cap at 100% for visualization
                                        const displayPercentage = Math.min(comparisonPercentage, 100);
                                        barFill.style.width = `${displayPercentage}%`;
                                    }, 100);

                                    areaComparisonElement.style.display = 'block';
                                } else {
                                    console.warn("USA details not found");
                                    areaComparisonElement.style.display = 'none';
                                }
                            } else {
                                console.warn("Country area not available");
                                areaComparisonElement.style.display = 'none';
                            }
                        } else {
                            console.warn(`No additional details found for country: ${countryDisplayName}`);
                            countryDetailsElement.style.display = 'none';
                            areaComparisonElement.style.display = 'none';
                        }
                    } else {
                        console.warn("Countries details data not available");
                        countryDetailsElement.style.display = 'none';
                        areaComparisonElement.style.display = 'none';
                    }

                } else {
                    console.warn(`No continent data found for country: ${countryName}`);
                    countryFlagElement.style.display = 'none';
                    countryDetailsElement.style.display = 'none';
                    areaComparisonElement.style.display = 'none';
                    document.getElementById('flag-country-name').textContent = "N/A";
                    document.getElementById('flag-continent-name').textContent = "N/A";
                }
            } catch (error) {
                console.error("Error loading continent data:", error);
                document.getElementById("country-flag").style.display = 'none';
                document.getElementById("country-details").style.display = 'none';
                document.getElementById("area-comparison").style.display = 'none';
            }
        }

        // Function to load and display the continent map
        // Fix the loadContinentMap function
        // Function to load and display the continent map
        async function loadContinentMap(continentName, countryName) {
            try {
                // Initialize the map only once
                if (!continentMap) {
                    continentMap = L.map('continent-map', {
                        preferCanvas: true,
                        zoomControl: false,
                        attributionControl: false
                    }).setView([20, 0], 2);

                    // Add tile layer only once
                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        maxZoom: 18,
                        attribution: "© OpenStreetMap contributors",
                    }).addTo(continentMap);
                } else {
                    // Clear existing layers if map already exists
                    continentMap.eachLayer(function (layer) {
                        if (layer instanceof L.TileLayer) return; // Keep the tile layer
                        continentMap.removeLayer(layer);
                    });
                }

                // Clear existing marker
                if (continentMapMarker) {
                    continentMap.removeLayer(continentMapMarker);
                    continentMapMarker = null;
                }

                // Filter GeoJSON for the specific continent
                const filteredContinentGeoJson = {
                    type: "FeatureCollection",
                    features: cache.continentGeoJson.features.filter(feature => {
                        const featureContinent = feature.properties.CONTINENT;
                        if (continentName === "Australia" || continentName === "Oceania") {
                            return featureContinent === "Australia" || featureContinent === "Oceania";
                        }
                        return featureContinent === continentName;
                    })
                };

                // Add the new continent layer
                continentMapGeoJsonLayer = L.geoJSON(filteredContinentGeoJson, {
                    style: {
                        color: "#e74c3c",
                        weight: 2,
                        fillOpacity: 0.7,
                        fillColor: "#e74c3c"
                    }
                }).addTo(continentMap);

                // FIXED: Proper bounds validation before calling flyToBounds
                const bounds = continentMapGeoJsonLayer.getBounds();
                if (bounds && bounds.isValid && bounds.isValid()) {
                    continentMap.flyToBounds(bounds, {
                        maxZoom: 3,
                        padding: [20, 20],
                        duration: 0.5
                    });
                } else {
                    console.warn("Invalid bounds for continent map layer. Resetting view.");
                    continentMap.setView([20, 0], 2);
                }

                // If we have country data, try to show a marker for the country's capital/center
                if (countryName) {
                    const countryMapping = cache.countryGeoJsonMapping.find(
                        item => item.country_name.toLowerCase() === countryName.toLowerCase()
                    );

                    if (countryMapping && countryMapping.center) {
                        const [lat, lng] = countryMapping.center;
                        continentMapMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'continent-country-marker',
                                html: '<i class="fas fa-map-marker-alt" style="color: #e74c3c; font-size: 24px;"></i>',
                                iconSize: [24, 24],
                                iconAnchor: [12, 24]
                            })
                        }).addTo(continentMap);
                    } else {
                        console.warn(`No center coordinates found for country: ${countryName} on continent map.`);
                    }
                }

                // Invalidate size to ensure proper rendering
                setTimeout(() => {
                    continentMap.invalidateSize();
                }, 100);
            } catch (error) {
                console.error("Error loading continent map:", error);
            }
        }

        // Renders the list of available countries in the UI
        function renderCountries(countries) {
            const countriesListUl = document.getElementById("countries-ul");
            countriesListUl.innerHTML = ""; // Clear existing list

            // Filter out countries that don't have any valid images
            const countriesWithImages = countries.filter(country => {
                const countryCoins = cache.coinsData.filter(coin =>
                    coin.country.toLowerCase() === country.toLowerCase()
                );

                // Check if any coin for this country has a valid image
                return countryCoins.some(coin =>
                    coin.image && coin.image.trim() !== "" && coin.image.toLowerCase() !== "none"
                );
            });

            // Update the total count of unique countries with images
            document.getElementById('total-countries-count').textContent = `(${countriesWithImages.length})`;

            const queryParams = new URLSearchParams(window.location.search);
            const currentCountryParam = queryParams.get("country") ? queryParams.get("country").toLowerCase() : null;
            const currentCoinParam = queryParams.get("coin"); // NEW: get current coin parameter

            countriesWithImages.forEach(country => {
                const li = document.createElement("li");
                const link = document.createElement("a");

                // NEW: Include coin parameter in href if present
                const href = currentCoinParam ? `?country=${country.toLowerCase()}&coin=${currentCoinParam}` : `?country=${country.toLowerCase()}`;
                link.textContent = country;
                link.href = href;

                // Set active class and update titles if this is the currently selected country
                if (currentCountryParam && country.toLowerCase() === currentCountryParam) {
                    link.classList.add("active");
                    // get the count of items for the selected country based on year values
                    const countryItems = cache.coinsData.filter(coin =>
                        coin.country.toLowerCase() === country.toLowerCase() &&
                        coin.image && coin.image.trim() !== "" && coin.image.toLowerCase() !== "none"
                    ).reduce((total, coin) => {
                        if (coin.year && coin.year.trim() !== "") {
                            // Count each comma-separated year value, minimum 1
                            const yearCount = Math.max(coin.year.split(',').length, 1);
                            return total + yearCount;
                        } else {
                            // Count as 1 for empty year field
                            return total + 1;
                        }
                    }, 0);
                    document.getElementById('selected-country').textContent = `: ${country}`;
                    document.getElementById('selected-country-title').textContent = `${country} (${countryItems})`;
                    updateTitle(`${country}`);
                }

                // Add click event listener to handle country selection
                link.addEventListener("click", event => {
                    event.preventDefault(); // Prevent default link behavior
                    const countryName = country.toLowerCase();

                    // Remove active class from all country links
                    document.querySelectorAll('.countries-list a').forEach(el => {
                        el.classList.remove('active');
                    });

                    // Add active class to the clicked link
                    link.classList.add('active');
                    // get the count of items for the selected country
                    const countryItems = cache.coinsData.filter(coin =>
                        coin.country.toLowerCase() === countryName.toLowerCase() &&
                        coin.image && coin.image.trim() !== "" && coin.image.toLowerCase() !== "none"
                    ).reduce((total, coin) => {
                        if (coin.year && coin.year.trim() !== "") {
                            const yearCount = Math.max(coin.year.split(',').length, 1);
                            return total + yearCount;
                        } else {
                            return total + 1;
                        }
                    }, 0);
                    document.getElementById('selected-country').textContent = `: ${country}`;
                    document.getElementById('selected-country-title').textContent = `${country} (${countryItems})`;
                    updateTitle(`${country}`);

                    // NEW: Update URL without reloading the page, preserving coin parameter if present
                    const currentParams = new URLSearchParams(window.location.search);
                    const currentCoin = currentParams.get("coin");
                    const newUrl = currentCoin ? `?country=${countryName}&coin=${currentCoin}` : `?country=${countryName}`;
                    history.pushState(null, "", newUrl);

                    // Trigger map highlight and image loading for the selected country
                    highlightCountry(countryName);
                    loadCountryImages(countryName);
                    loadGalleryView(countryName);
                });

                li.appendChild(link);
                countriesListUl.appendChild(li);
            });
        }


        // Fetches country-specific information from cached data
        function fetchCountryInfo(countryName) {
            if (!cache.countriesData) {
                console.error("Countries data not loaded from cache.");
                return null;
            }
            return cache.countriesData.find(country => country.name.toLowerCase() === countryName.toLowerCase());
        }

        // Initializes the main Leaflet map
        function initializeMap() {
            // Initialize the map only once
            if (!mainMap) {
                mainMap = L.map("map", {
                    preferCanvas: true, // Use Canvas renderer for better performance
                    zoomControl: false, // We'll add our own control
                    attributionControl: false // Disable attribution for cleaner look
                }).setView([20, 0], 2); // Initial view

                // Add tile layer only once
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    maxZoom: 18,
                    attribution: "© OpenStreetMap contributors",
                    retry: 3, // Retry loading tiles 3 times
                    detectRetina: true // Better rendering on retina displays
                }).addTo(mainMap);

                // Add custom zoom control with home button
                L.control.zoom({
                    position: 'topright'
                }).addTo(mainMap);
            }

            // Function to highlight a specific country on the main map
            async function highlightCountry(countryName) {
                try {
                    const countryMapping = cache.countryGeoJsonMapping.find(
                        item => item.country_name.toLowerCase() === countryName.toLowerCase()
                    );

                    if (!countryMapping) {
                        console.warn(`No GeoJSON mapping found for country: ${countryName}. Cannot highlight.`);
                        // Optionally, clear any existing highlight if no mapping is found
                        if (mainMapGeoJsonLayer) {
                            mainMap.removeLayer(mainMapGeoJsonLayer);
                            mainMapGeoJsonLayer = null;
                        }
                        return;
                    }

                    let geojson = countryMapping.geojson;
                    // If GeoJSON is not cached, fetch it
                    if (!geojson) {
                        const response = await fetch(countryMapping.file_name);
                        geojson = await response.json();
                        countryMapping.geojson = geojson; // Cache the GeoJSON for future use
                    }

                    displayCountryHighlight(mainMap, geojson);
                } catch (error) {
                    console.error(`Error highlighting country ${countryName}:`, error);
                }
            }

            // Displays the GeoJSON highlight on the map
            function displayCountryHighlight(mapInstance, geojson) {
                // Remove existing highlight layer if it exists
                if (mainMapGeoJsonLayer) {
                    mapInstance.removeLayer(mainMapGeoJsonLayer);
                }

                mainMapGeoJsonLayer = L.geoJSON(geojson, {
                    style: {
                        color: "#e74c3c",
                        weight: 2,
                        fillOpacity: 0.2,
                        fillColor: "#e74c3c"
                    },
                    onEachFeature: function (feature, layer) {
                        const name = feature.properties?.name || feature.properties?.ADMIN || "Unknown";
                        layer.bindTooltip(name, {
                            permanent: false,
                            direction: "center",
                            className: "country-tooltip"
                        });
                    }
                }).addTo(mapInstance);


                const bounds = mainMapGeoJsonLayer.getBounds();
                if (bounds.isValid()) {
                    mapInstance.flyToBounds(bounds, {
                        padding: [50, 50], // Add padding around the country
                        maxZoom: 6, // Don't zoom in too close
                        duration: 1 // Smooth animation
                    });
                } else {
                    console.warn("Invalid bounds for country highlight layer. Skipping fitBounds.");
                }
            }

            // Function to show all available countries in a light green color
            async function showAvailableCountries(availableCountries) {
                // Remove existing layer if it exists
                if (availableCountriesLayer) {
                    mainMap.removeLayer(availableCountriesLayer);
                }

                // Create a new layer group for available countries
                availableCountriesLayer = L.layerGroup().addTo(mainMap);

                // Filter to only include mappings for countries that have coin data
                const availableMappings = cache.countryGeoJsonMapping.filter(item =>
                    availableCountries.some(c => c.toLowerCase() === item.country_name.toLowerCase())
                );

                // Process each available country mapping
                for (const countryMapping of availableMappings) {
                    try {
                        let geojson = countryMapping.geojson;
                        // If GeoJSON is not cached, fetch and cache it
                        if (!geojson) {
                            const response = await fetch(countryMapping.file_name);
                            geojson = await response.json();
                            countryMapping.geojson = geojson; // Cache it
                        }

                        // Add GeoJSON to the map with styling and interaction
                        L.geoJSON(geojson, {
                            style: {
                                color: "#4CAF50", // Light green color
                                weight: 1,
                                fillOpacity: 0.3,
                                fillColor: "#4CAF50"
                            },
                            onEachFeature: (feature, layer) => {
                                const name = feature.properties?.name || feature.properties?.ADMIN || countryMapping.country_name;

                                // Show tooltip on hover
                                layer.bindTooltip(name, {
                                    permanent: false,   // show only on hover
                                    direction: "center",
                                    className: "country-tooltip"
                                });

                                layer.on({
                                    click: () => {
                                        const countryName = countryMapping.country_name;
                                        // Update URL, preserving coin parameter if present
                                        const currentParams = new URLSearchParams(window.location.search);
                                        const currentCoin = currentParams.get("coin");
                                        const newUrl = currentCoin ? `?country=${countryName.toLowerCase()}&coin=${currentCoin}` : `?country=${countryName.toLowerCase()}`;
                                        history.pushState(null, "", newUrl);

                                        highlightCountry(countryName.toLowerCase());
                                        loadCountryImages(countryName.toLowerCase());
                                        loadGalleryView(countryName.toLowerCase());

                                        // update country list active state
                                        document.querySelectorAll('.countries-list a').forEach(el => {
                                            el.classList.remove('active');
                                            if (el.textContent.toLowerCase() === countryName.toLowerCase()) {
                                                el.classList.add('active');
                                                const countryItems = cache.coinsData.filter(
                                                    coin => coin.country.toLowerCase() === countryName.toLowerCase()
                                                ).length;
                                                document.getElementById('selected-country').textContent = `: ${countryName}`;
                                                document.getElementById('selected-country-title').textContent = `${countryName} (${countryItems})`;
                                                updateTitle(`${countryName}`);
                                            }
                                        });
                                    },
                                    mouseover: () => {
                                        layer.setStyle({ fillOpacity: 0.5 });
                                    },
                                    mouseout: () => {
                                        layer.setStyle({ fillOpacity: 0.3 });
                                    }
                                });
                            }

                        }).addTo(availableCountriesLayer);
                    } catch (error) {
                        console.error(`Error loading GeoJSON for ${countryMapping.country_name}:`, error);
                    }
                }
            }

            // Expose highlightCountry globally for external calls (e.g., from search)
            window.highlightCountry = highlightCountry;

            return {
                map: mainMap, // Return the map instance
                highlightCountry,
                showAvailableCountries
            };
        }




        // Load and display images in gallery view with filter support
        function loadGalleryView(countryName) {
            const allCountryCoins = cache.coinsData.filter(coin => coin.country.toLowerCase() === countryName);

            // Apply active filters (support multiple toggles)
            const activeFilters = window.distributionData?.activeFilters || [];
            const filteredCoins = (activeFilters.length > 0) ?
                allCountryCoins.filter(coin => {
                    if (!coin.currency_type) return false;
                    const types = coin.currency_type.split(',').map(t => t.trim().toLowerCase());
                    return types.some(t => activeFilters.includes(t));
                }) :
                allCountryCoins;


            // Update distribution data with current country coins
            if (window.distributionData) {
                window.distributionData.coinsData = allCountryCoins;
            }

            updateGalleryViewWithFilter(countryName, filteredCoins);

            // Reset to first image if current index is invalid
            if (currentImageIndex >= filteredCoins.length) {
                currentImageIndex = 0;
            }

            // Update main display if we have coins
            if (filteredCoins.length > 0) {
                updateImageDisplay(currentImageIndex, filteredCoins);
            }
        }

        // NEW: Event listeners for sorting and filtering
        document.getElementById('sort-by').addEventListener('change', () => {
            const queryParams = new URLSearchParams(window.location.search);
            const countryQuery = queryParams.get("country");
            if (countryQuery) {
                loadGalleryView(countryQuery.toLowerCase());
            }
        });

        document.getElementById('filter-by').addEventListener('change', () => {
            const queryParams = new URLSearchParams(window.location.search);
            const countryQuery = queryParams.get("country");
            if (countryQuery) {
                loadGalleryView(countryQuery.toLowerCase());
            }
        });


        // Initializes the collapsible details section
        // Fix the initDetailsToggle function
        function initDetailsToggle() {
            const toggle = document.querySelector('.details-toggle');
            const content = document.querySelector('.details-content');
            const continentMapContainer = document.getElementById('continent-map-container');

            toggle.addEventListener('click', () => {
                toggle.classList.toggle('collapsed');
                content.classList.toggle('show');
                const isContinentMapVisible = continentMapContainer.classList.toggle('show');

                const chevronIcon = toggle.querySelector('.fa-chevron-down');
                if (content.classList.contains('show')) {
                    chevronIcon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                } else {
                    chevronIcon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                }

                // Invalidate size of the continent map when its container becomes visible
                if (isContinentMapVisible && continentMap) {
                    // Use a small timeout to ensure the CSS transition completes
                    setTimeout(() => {
                        continentMap.invalidateSize();
                    }, 300);
                }
            });
        }

        // Initializes the image modal for enlarged view
        function initImageModal() {
            const imageModal = document.getElementById("imageModal");
            const closeModal = document.querySelector(".close-modal");
            const currentImage = document.getElementById("current-image-img");

            // In initImageModal function, update the currentImage click event:
            currentImage.addEventListener("click", function () {
                const queryParams = new URLSearchParams(window.location.search);
                const countryQuery = queryParams.get("country").toLowerCase();
                const countryInfo = fetchCountryInfo(countryQuery);
                const currentCoin = currentCountryCoins[currentImageIndex];
                const imagePath = `images/${toTitleCase(countryQuery)}/${currentCoin.image}`;
                openImageModal(
                    imagePath,
                    currentCoin.note,
                    countryInfo.name,
                    countryInfo.capital,
                    countryInfo.currency?.name,
                    currentImageIndex,
                    currentCoin.donor_name  // ADD DONOR PARAMETER
                );
            });

            const prevModalBtn = document.getElementById('prev-modal-btn');
            const nextModalBtn = document.getElementById('next-modal-btn');

            prevModalBtn.addEventListener('click', () => changeModalImage(-1));
            nextModalBtn.addEventListener('click', () => changeModalImage(1));

            // Fix for close button - prevent event propagation
            closeModal.addEventListener("click", function (e) {
                e.stopPropagation(); // Prevent event from bubbling up to modal
                imageModal.style.display = "none";
                document.body.style.overflow = "auto"; // Restore scrolling
            });

            // Close modal when clicking outside the image
            imageModal.addEventListener("click", function (event) {
                if (event.target === imageModal) {
                    imageModal.style.display = "none";
                    document.body.style.overflow = "auto";
                }
            });

            // Close modal on Escape key press
            document.addEventListener("keydown", function (event) {
                if (event.key === "Escape" && imageModal.style.display === "flex") {
                    imageModal.style.display = "none";
                    document.body.style.overflow = "auto";
                }
            });
        }

        function openImageModal(imageUrl, note, countryName, capital, currencyName, index, donorName) {
            const imageModal = document.getElementById("imageModal");
            const modalImage = document.getElementById("modalImage");
            const modalDetails = document.getElementById("image-modal-details");

            modalImage.src = imageUrl;
            imageModal.style.display = "flex";
            document.body.style.overflow = "hidden";

            // Set details - ADD DONOR INFORMATION HERE
            document.getElementById('modal-country-name').style.color = 'white';
            document.getElementById('modal-country-name').textContent = countryName;
            document.getElementById('modal-capital-name').style.color = 'white';
            document.getElementById('modal-capital-name').textContent = capital;
            document.getElementById('modal-currency-name').style.color = 'white';
            document.getElementById('modal-currency-name').textContent = currencyName;
            document.getElementById('modal-note').style.color = 'white';
            document.getElementById('modal-note').textContent = note;

            // ADD THIS SECTION FOR DONOR INFO
            const donorElement = document.getElementById('modal-donor');
            if (donorElement) {
                donorElement.textContent = donorName;
            } else {
                // Create donor element if it doesn't exist
                const modalDetailsDiv = document.getElementById('image-modal-details');
                const donorP = document.createElement('p');
                donorP.innerHTML = '<strong>Donor:</strong> <span id="modal-donor" style="color: white;">' + (donorName || 'Unknown') + '</span>';
                modalDetailsDiv.appendChild(donorP);
            }

            modalDetails.style.display = 'block';

            currentImageIndex = index;
        }


        function changeModalImage(direction) {
            if (currentCountryCoins.length > 0) {
                currentImageIndex = (currentImageIndex + direction + currentCountryCoins.length) % currentCountryCoins.length;
                const coin = currentCountryCoins[currentImageIndex];

                const queryParams = new URLSearchParams(window.location.search);
                const countryQuery = queryParams.get("country").toLowerCase();
                const countryInfo = fetchCountryInfo(countryQuery);

                const imageUrl = `images/${toTitleCase(countryQuery)}/${coin.image}`;

                document.getElementById('modalImage').src = imageUrl;
                document.getElementById('modal-country-name').textContent = countryInfo.name;
                document.getElementById('modal-capital-name').textContent = countryInfo.capital;
                document.getElementById('modal-currency-name').textContent = countryInfo.currency?.name;
                document.getElementById('modal-note').textContent = coin.note;

                // ADD DONOR INFO UPDATE
                document.getElementById('modal-donor').textContent = coin.donor_name || 'Unknown';

                // FIX: Update URL when navigating in modal
                updateURLWithCurrentCoin();
            }
        }

        // Initializes the flag modal for enlarged view
        function initFlagModal() {
            const flagModal = document.getElementById("flagModal");
            const closeFlagModal = document.querySelector(".close-flag-modal");

            closeFlagModal.addEventListener("click", function () {
                flagModal.style.display = "none";
                document.body.style.overflow = "auto"; // Restore scrolling
            });

            // Close modal when clicking outside the image
            flagModal.addEventListener("click", function (event) {
                if (event.target === flagModal) {
                    flagModal.style.display = "none";
                    document.body.style.overflow = "auto";
                }
            });

            // Close modal on Escape key press
            document.addEventListener("keydown", function (event) {
                if (event.key === "Escape" && flagModal.style.display === "flex") {
                    flagModal.style.display = "none";
                    document.body.style.overflow = "auto";
                }
            });
        }

        // Function to open the flag modal with the specified flag image
        function openFlagModal(flagSrc) {
            const flagModal = document.getElementById("flagModal");
            const flagModalImage = document.getElementById("flagModalImage");
            const flagModalDetails = document.getElementById("flag-modal-details");

            flagModalImage.src = flagSrc;
            flagModal.style.display = "flex";
            document.body.style.overflow = "hidden"; // Prevent scrolling when modal is open

            // Show details container
            flagModalDetails.style.display = 'block';
        }


        // Initializes the search functionality for countries
        function initSearch() {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');

            searchInput.addEventListener('input', function () {
                const query = this.value.toLowerCase().trim();
                searchResults.innerHTML = ''; // Clear previous results

                if (query.length < 2) {
                    searchResults.classList.remove('show');
                    return;
                }

                if (!cache.coinsData) {
                    console.error("Coins data not loaded for search.");
                    return;
                }

                // Get unique countries from cached coin data and sort them
                const countries = [...new Set(cache.coinsData.map(coin => toTitleCase(coin.country)))].sort();
                const filteredCountries = countries.filter(country =>
                    country.toLowerCase().includes(query)
                );

                if (filteredCountries.length > 0) {
                    filteredCountries.forEach(country => {
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('search-result-item');
                        resultItem.textContent = country;
                        resultItem.addEventListener('click', function () {
                            // Update active country link in the list
                            document.querySelectorAll('.countries-list a').forEach(el => {
                                el.classList.remove('active');
                                if (el.textContent.toLowerCase() === country.toLowerCase()) {
                                    el.classList.add('active');
                                    const countryItems = cache.coinsData.filter(coin => coin.country.toLowerCase() === country.toLowerCase()).length;
                                    document.getElementById('selected-country').textContent = `: ${country}`;
                                    document.getElementById('selected-country-title').textContent = `${country} (${countryItems})`;
                                    updateTitle(`${country}`);
                                }
                            });

                            // NEW: Update URL, preserving coin parameter if present
                            const currentParams = new URLSearchParams(window.location.search);
                            const currentCoin = currentParams.get("coin");
                            const newUrl = currentCoin ? `?country=${country.toLowerCase()}&coin=${currentCoin}` : `?country=${country.toLowerCase()}`;
                            history.pushState(null, "", newUrl);

                            highlightCountry(country.toLowerCase());
                            loadCountryImages(country.toLowerCase());
                            loadGalleryView(country.toLowerCase());
                            searchInput.value = country; // Set search input to selected country
                            searchResults.classList.remove('show'); // Hide search results
                        });
                        searchResults.appendChild(resultItem);
                    });
                    searchResults.classList.add('show'); // Show search results
                } else {
                    searchResults.classList.remove('show'); // Hide if no results
                }
            });

            // Hide search results when clicking outside the search input/results
            document.addEventListener('click', function (event) {
                if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
                    searchResults.classList.remove('show');
                }
            });
        }

        // NEW: Function to toggle between slider and gallery view
        function initViewToggle() {
            const toggleBtn = document.getElementById('toggle-view-btn');
            const sliderView = document.getElementById('slider-view');
            const galleryView = document.getElementById('gallery-view');

            let isSliderView = true;

            toggleBtn.addEventListener('click', () => {
                isSliderView = !isSliderView;

                if (isSliderView) {
                    sliderView.style.display = 'flex';
                    galleryView.style.display = 'none';
                    toggleBtn.innerHTML = '<i class="fas fa-th"></i> Grid View';
                } else {
                    sliderView.style.display = 'none';
                    galleryView.style.display = 'flex';
                    toggleBtn.innerHTML = '<i class="fas fa-images"></i> Slider View';
                }

                // Reload content for the current country
                const queryParams = new URLSearchParams(window.location.search);
                const countryQuery = queryParams.get("country");
                if (countryQuery) {
                    loadCountryImages(countryQuery.toLowerCase());
                    loadGalleryView(countryQuery.toLowerCase());
                }
            });
        }

        // NEW: Back to Top functionality
        function initBackToTop() {
            const backToTopBtn = document.getElementById('back-to-top');

            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            });

            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }


        window.onload = async () => {
            // Preload all data first. If it fails, log error and stop initialization.
            const preloadSuccess = await preloadData();
            if (!preloadSuccess) {
                console.error("Application failed to load necessary data. Please check network and file paths.");
                return; // Stop execution if data preload fails
            }

            // Get country and coin from URL query parameters
            const queryParams = new URLSearchParams(window.location.search);
            const countryQuery = queryParams.get("country") || "default";
            const coinQuery = queryParams.get("coin"); // New: get specific coin parameter

            // Get unique countries from cached coin data and sort them alphabetically
            const countries = [...new Set(cache.coinsData.map(coin => toTitleCase(coin.country)))].sort();
            renderCountries(countries); // Render the list of countries

            // Initialize the main map and get its controller functions
            const mapController = initializeMap();

            // Show all available countries on the main map
            mapController.showAvailableCountries(countries);

            // If a country is specified in the URL, load its images and highlight it
            if (countryQuery !== "default") {
                highlightCountry(countryQuery.toLowerCase());
                loadCountryImages(countryQuery.toLowerCase());
                loadGalleryView(countryQuery.toLowerCase());

                // NEW: If a specific coin is also specified, navigate to that coin
                if (coinQuery) {
                    // Small delay to ensure country images are loaded first
                    setTimeout(() => {
                        navigateToSpecificCoin(coinQuery);
                    }, 100);
                }
            } else if (countries.length > 0) {
                // If no country is specified, load images for the first available country
                const firstCountry = countries[0].toLowerCase();
                history.pushState(null, "", `?country=${firstCountry}`); // Update URL
                highlightCountry(firstCountry);
                loadCountryImages(firstCountry);
                loadGalleryView(firstCountry);

                // Also set the first country as active in the list
                const firstCountryLink = document.querySelector(`.countries-list a[href="?country=${firstCountry}"]`);
                if (firstCountryLink) {
                    firstCountryLink.classList.add('active');
                    const countryItems = cache.coinsData.filter(coin => coin.country.toLowerCase() === firstCountry).length;
                    document.getElementById('selected-country').textContent = `: ${countries[0]}`;
                    document.getElementById('selected-country-title').textContent = `${countries[0]} (${countryItems})`;
                    updateTitle(`${countries[0]}`);
                }
            }

            // Initialize various UI components
            initDetailsToggle();
            initImageModal();
            initFlagModal();
            initSearch();
            initViewToggle();
            initBackToTop();
        };
    </script>
    <script type="text/javascript">


        function updateTitle(countryName) {
            // Get the current base title (this should be "..::Amir's Coin Collection::..")
            let baseTitle = "..::Amir's Coin Collection::..";

            // Combine with the country name and a space
            let newTitle = baseTitle + " " + countryName;

            // Set the new title
            document.title = newTitle;

            // Optional logging
            console.log("Updated Title:", newTitle);
        }


        // NEW: Function to navigate to a specific coin by image filename
        function navigateToSpecificCoin(coinFilename) {
            if (!currentCountryCoins || currentCountryCoins.length === 0) {
                console.warn("No country coins loaded yet");
                return;
            }

            // Find the coin index by matching the filename (with or without extension)
            const coinIndex = currentCountryCoins.findIndex(coin => {
                const coinImageName = coin.image.toLowerCase();
                const searchName = coinFilename.toLowerCase();

                // Match with or without file extension
                return coinImageName === searchName ||
                    coinImageName === `${searchName}.jpg` ||
                    coinImageName === `${searchName}.jpeg` ||
                    coinImageName === `${searchName}.png` ||
                    coinImageName.split('.')[0] === searchName;
            });

            if (coinIndex !== -1) {
                // Navigate to the specific coin
                updateImageDisplay(coinIndex, currentCountryCoins);

                // Update URL to include both country and coin
                const queryParams = new URLSearchParams(window.location.search);
                const country = queryParams.get("country");
                const cleanCoinName = currentCountryCoins[coinIndex].image.split('.')[0];
                history.replaceState(null, "", `?country=${country}&coin=${cleanCoinName}`);

                console.log(`Navigated to coin: ${currentCountryCoins[coinIndex].image}`);
            } else {
                console.warn(`Coin not found: ${coinFilename}`);
            }
        }

        // --- URL-in-Note support ---
        function formatNoteWithURLs(text) {
            if (!text) return "";
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return String(text).replace(urlRegex, function (url) {
                const display = url.length > 60 ? url.slice(0, 60) + "…" : url;
                return '<a href="#" class="note-url-link" data-url="' + url + '">' + display + '</a>';
            });
        }

        (function initNoteURLModal() {
            const urlModal = document.getElementById('url-modal');
            const urlModalIframe = document.getElementById('url-modal-iframe');
            const closeBtn = document.getElementById('close-url-modal');

            function openUrlModal(url) {
                urlModalIframe.src = url;
                urlModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            function closeUrlModal() {
                urlModal.style.display = 'none';
                urlModalIframe.src = 'about:blank';
                document.body.style.overflow = 'auto';
            }

            // Close actions
            if (closeBtn) closeBtn.addEventListener('click', closeUrlModal);
            if (urlModal) urlModal.addEventListener('click', function (e) {
                if (e.target === urlModal) closeUrlModal();
            });

            // Event delegation for dynamically-inserted links in the Note
            document.addEventListener('click', function (e) {
                const t = e.target;
                if (t && t.classList && t.classList.contains('note-url-link')) {
                    e.preventDefault();
                    const url = t.getAttribute('data-url');
                    if (url) openUrlModal(url);
                }
            });
        })();

    </script>
    <script>
        // URL helpers
        function hasURL(text) {
            return /(https?:\/\/[^\s]+)/g.test(text);
        }
        function formatNoteWithURLs(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url =>
                `<a href="#" class="url-link" data-url="${url}">${url}</a>`
            );
        }
        function setupURLLinkListeners() {
            document.querySelectorAll(".url-link").forEach(link => {
                link.onclick = e => {
                    e.preventDefault();
                    openUrlModal(link.dataset.url);
                };
            });
        }

        // URL modal controls
        document.addEventListener("DOMContentLoaded", () => {
            const urlModal = document.getElementById("url-modal");
            const urlModalIframe = document.getElementById("url-modal-iframe");
            const closeUrlModal = document.querySelector("#url-modal .close-modal");

            function openUrlModal(url) {
                urlModalIframe.src = url;
                urlModal.style.display = "block";
                document.body.style.overflow = "hidden";
            }
            function closeUrlModalHandler() {
                urlModal.style.display = "none";
                urlModalIframe.src = "about:blank";
                document.body.style.overflow = "auto";
            }

            closeUrlModal.addEventListener("click", closeUrlModalHandler);
            urlModal.addEventListener("click", e => {
                if (e.target === urlModal) closeUrlModalHandler();
            });

            // Expose globally so setupURLLinkListeners can call it
            window.openUrlModal = openUrlModal;
        });

        // Initialize URL modal behavior
        function initUrlModal() {
            const urlModal = document.getElementById("url-modal");
            const closeUrlModal = document.querySelector(".close-url-modal");
            const iframe = document.getElementById("url-modal-iframe");

            // Open when clicking note links
            document.body.addEventListener("click", function (e) {
                if (e.target.classList.contains("note-url-link")) {
                    e.preventDefault();
                    const url = e.target.getAttribute("data-url") || e.target.href;
                    iframe.src = url;
                    urlModal.style.display = "block";
                    document.body.style.overflow = "hidden";
                }
            });

            // Close modal
            closeUrlModal.addEventListener("click", function () {
                urlModal.style.display = "none";
                iframe.src = "about:blank"; // reset
                document.body.style.overflow = "auto";
            });

            // Close when clicking outside
            urlModal.addEventListener("click", function (e) {
                if (e.target === urlModal) {
                    urlModal.style.display = "none";
                    iframe.src = "about:blank";
                    document.body.style.overflow = "auto";
                }
            });
        }

        // Call after DOM is ready
        document.addEventListener("DOMContentLoaded", initUrlModal);

        function formatNoteWithURLs(note) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return note.replace(urlRegex, function (url) {
                return `<a href="${url}" class="note-url-link" target="_blank">${url}</a>`;
            });
        }

        // Helper function to get USA area for comparison
        function getUSAArea() {
            if (!cache.countriesDetails) return null;

            const usa = cache.countriesDetails.find(c =>
                c.name.toLowerCase().includes("united states") ||
                c.alpha3Code === "USA"
            );

            return usa ? usa.area : 9833517; // Default USA area in km² if not found
        }
    </script>
    <script>


        // Enhanced updateImage function to highlight the corresponding timeline bar
        function updateImage(index) {
            if (currentCountryCoins.length === 0) return;

            const coin = currentCountryCoins[index];

            // Remove highlight from all timeline bars
            document.querySelectorAll('.timeline-bar').forEach(bar => {
                bar.style.boxShadow = 'none';
                bar.style.border = 'none';
            });

            // Highlight all bars that correspond to this coin's image
            if (coin.image) {
                document.querySelectorAll(`.timeline - bar[data - image="${coin.image}"]`).forEach(bar => {
                    bar.style.boxShadow = '0 0 0 2px #e74c3c';
                    bar.style.border = '2px solid white';
                });
            }
        }



        // Update the updateImage function to highlight the corresponding timeline bar
        function updateImage(index) {
            if (currentCountryCoins.length === 0) return;

            const coin = currentCountryCoins[index];

            // Remove highlight from all timeline bars
            document.querySelectorAll('.timeline-bar').forEach(bar => {
                bar.style.boxShadow = 'none';
                bar.style.border = 'none';
            });

            // Find and highlight the corresponding timeline bar(s)
            if (coin.year) {
                const years = coin.year.split(',').map(y => y.trim());
                years.forEach(yearValue => {
                    const year = parseInt(yearValue);
                    if (!isNaN(year)) {
                        document.querySelectorAll(`.timeline - bar[data - year="${year}"]`).forEach(bar => {
                            if (bar.dataset.coinName === coin.image) {
                                bar.style.boxShadow = '0 0 0 2px #e74c3c';
                                bar.style.border = '2px solid white';
                            }
                        });
                    }
                });
            }
        }
    </script>
    <script>




        // Helper function to update image display when clicked from timeline
        async function updateImageFromTimeline(index) {
            if (currentCountryCoins.length === 0) return;

            const coin = currentCountryCoins[index];
            const countryName = coin.country.toLowerCase();
            const imagePath = `images/${toTitleCase(countryName)}/${coin.image}`;

            // Update thumbnails active state
            document.querySelectorAll('.img-queue-in img').forEach((img, idx) => {
                if (idx === index) {
                    img.classList.add('active-thumbnail');
                } else {
                    img.classList.remove('active-thumbnail');
                }
            });

            // Update main image
            const image = document.getElementById("current-image-img");
            image.setAttribute("src", imagePath);
            document.getElementById("modalImage").setAttribute("src", imagePath);

            // Update details
            const countryInfo = await fetchCountryInfo(countryName);
            await setCurrentImage(imagePath, coin.note, coin.donor_name, coin.currency_type, countryInfo, coin.year, coin.size, index);

            // Update timeline highlighting
            updateTimelineHighlight(coin.image);

            currentImageIndex = index;
        }


        // // In the createTimelineVisualization function, add this at the end:
        // const timelineLegend = document.getElementById('timeline-legend');
        // if (allYears.length > 0) {
        //     timelineLegend.style.display = 'flex';
        // } else {
        //     timelineLegend.style.display = 'none';
        // }

        // Loads and displays coin images for a selected country in slider view
        function loadCountryImages(countryName) {
            if (!cache.coinsData) {
                console.error("Coins data not loaded from cache.");
                return;
            }

            currentCountryCoins = cache.coinsData.filter(coin => coin.country.toLowerCase() === countryName);
            const imageElements = currentCountryCoins.map(coin => ({
                src: `images/${toTitleCase(countryName)}/${coin.image}`,
                note: coin.note,
                donor: coin.donor_name,
                currency_type: coin.currency_type,
                year: coin.year,
                size: coin.size
            }));

            const thumbnailContainer = document.getElementById("thumbnail-container");
            thumbnailContainer.innerHTML = ""; // Clear existing thumbnails
            currentImageIndex = 0; // Reset index for new country

            // Function to update timeline highlighting based on current image
            function updateTimelineHighlight(imageName) {
                // Remove highlight from all bars
                document.querySelectorAll('.timeline-bar').forEach(bar => {
                    bar.classList.remove('active');
                    bar.style.boxShadow = 'none';
                    bar.style.border = 'none';
                });

                // Highlight bars with matching image
                if (imageName) {
                    document.querySelectorAll(`.timeline-bar[data-image="${imageName}"]`).forEach(bar => {
                        bar.classList.add('active');
                        bar.style.boxShadow = '0 0 0 2px #e74c3c';
                        bar.style.border = '2px solid white';
                    });
                }
            }

            // Function to update the main image and details
            const updateImage = async (index) => {
                if (imageElements.length === 0) {
                    // Handle case where no images are found for the country
                    setCurrentImage("https://placehold.co/600x400/cccccc/333333?text=No+Coins+Found", "No coin details available.", null, null, null, null, null, 0);
                    document.getElementById("thumbnail-container").innerHTML = ""; // Clear thumbnails
                    return;
                }

                currentImageIndex = index;
                const { src, note, donor, currency_type, year, size } = imageElements[index];

                // Remove active class from all thumbnails
                document.querySelectorAll('.img-queue-in img').forEach(img => {
                    img.classList.remove('active-thumbnail');
                });

                // Add active class to the current thumbnail
                if (thumbnailContainer.children[index]) {
                    thumbnailContainer.children[index].classList.add('active-thumbnail');
                }

                const countryInfo = await fetchCountryInfo(countryName);
                await setCurrentImage(src, note, donor, currency_type, countryInfo, year, size, index);

                // Update timeline highlighting
                updateTimelineHighlight(currentCountryCoins[index].image);

                // FIX: Always update URL when image changes
                updateURLWithCurrentCoin();
            };

            // Function to change the image based on direction (-1 for prev, 1 for next)
            const changeImage = (direction) => {
                if (imageElements.length > 0) {
                    currentImageIndex = (currentImageIndex + direction + imageElements.length) % imageElements.length;
                    updateImage(currentImageIndex);
                    // URL update is now handled inside updateImage
                }
            };

            // Helper function to update image display when clicked from timeline
            window.updateImageFromTimeline = async function (index) {
                if (currentCountryCoins.length === 0) return;

                const coin = currentCountryCoins[index];
                const countryName = coin.country.toLowerCase();
                const imagePath = `images/${toTitleCase(countryName)}/${coin.image}`;

                // Update thumbnails active state
                document.querySelectorAll('.img-queue-in img').forEach((img, idx) => {
                    if (idx === index) {
                        img.classList.add('active-thumbnail');
                    } else {
                        img.classList.remove('active-thumbnail');
                    }
                });

                // Update main image
                const image = document.getElementById("current-image-img");
                image.setAttribute("src", imagePath);
                document.getElementById("modalImage").setAttribute("src", imagePath);

                // Update details
                const countryInfo = await fetchCountryInfo(countryName);
                await setCurrentImage(imagePath, coin.note, coin.donor_name, coin.currency_type, countryInfo, coin.year, coin.size, index);

                // Update timeline highlighting
                updateTimelineHighlight(coin.image);

                currentImageIndex = index;

                // FIX: Update URL when image changes from timeline
                updateURLWithCurrentCoin();
            };

            // Add event listeners for navigation buttons
            document.getElementById("prev-btn").onclick = () => changeImage(-1);
            document.getElementById("next-btn").onclick = () => changeImage(1);

            // Add keyboard navigation
            window.onkeydown = (event) => {
                const isSliderView = document.getElementById('slider-view').style.display !== 'none';

                // Handle keyboard navigation for the main slider
                if (isSliderView) {
                    if (event.key === "ArrowLeft") {
                        changeImage(-1);
                    } else if (event.key === "ArrowRight") {
                        changeImage(1);
                    }
                }

                // Handle keyboard navigation for the modal
                if (document.getElementById("imageModal").style.display === "flex") {
                    if (event.key === "ArrowLeft") {
                        changeModalImage(-1);
                    } else if (event.key === "ArrowRight") {
                        changeModalImage(1);
                    }
                }
            };

            // Populate thumbnail container
            imageElements.forEach((img, index) => {
                const thumbnail = document.createElement("img");
                thumbnail.src = img.src;
                thumbnail.alt = `Thumbnail ${index + 1}`;
                thumbnail.loading = "lazy"; // Lazy load thumbnails
                thumbnail.addEventListener("click", () => {
                    updateImage(index); // Update the main display when thumbnail is clicked
                });
                thumbnailContainer.appendChild(thumbnail);
            });

            // Display the first image if available
            if (imageElements.length > 0) {
                updateImage(currentImageIndex);
            } else {
                // Display a default message if no images for the country
                setCurrentImage("https://placehold.co/600x400/cccccc/333333?text=No+Coins+Found", "No coin details available.", null, null, null, null, null, 0);
            }

            // Create timeline visualization and currency distribution chart
            createTimelineVisualization(currentCountryCoins);
            createCurrencyDistributionChart(currentCountryCoins);
        }

        // Function to create timeline visualization with stacked bars using image as unique identifier
        function createTimelineVisualization(coinsData) {
            const timelineSection = document.getElementById('timeline-section');
            const timelineContainer = document.getElementById('timeline-container');
            const timelineStats = document.getElementById('timeline-stats');

            // Extract and process all years from coins data (handling multiple years per coin)
            const allYears = [];

            coinsData.forEach(coin => {
                if (coin.year && coin.image) {
                    // Split by comma and trim each value to handle multiple years
                    const years = coin.year.split(',').map(y => y.trim());
                    years.forEach(yearValue => {
                        const year = parseInt(yearValue);
                        if (!isNaN(year) && year > 1000 && year <= new Date().getFullYear()) {
                            allYears.push({
                                year: year,
                                coin: coin,
                                originalValue: yearValue,
                                image: coin.image // Use image as unique identifier
                            });
                        }
                    });
                }
            });

            if (allYears.length === 0) {
                timelineSection.style.display = 'none';
                return;
            }

            // Show timeline section
            timelineSection.style.display = 'block';
            timelineContainer.innerHTML = '';

            // Group coins by year for stacked bars
            const yearGroups = {};
            allYears.forEach(item => {
                if (!yearGroups[item.year]) {
                    yearGroups[item.year] = [];
                }
                yearGroups[item.year].push(item);
            });

            // Get year range
            const years = Object.keys(yearGroups).map(y => parseInt(y));
            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);
            const yearRange = Math.max(1, maxYear - minYear);

            // Update stats
            const uniqueYears = Object.keys(yearGroups).length;
            timelineStats.textContent = `${minYear} - ${maxYear} (${yearRange} years, ${uniqueYears} unique years, ${allYears.length} items)`;

            // Create timeline axis
            const axis = document.createElement('div');
            axis.className = 'timeline-axis';
            timelineContainer.appendChild(axis);

            // Calculate maximum coins per year for scaling
            const maxCoinsPerYear = Math.max(...Object.values(yearGroups).map(group => group.length));

            // Create bars for each year group
            Object.keys(yearGroups).sort((a, b) => parseInt(a) - parseInt(b)).forEach(year => {
                const yearNum = parseInt(year);
                const coinsInYear = yearGroups[year];
                const position = ((yearNum - minYear) / yearRange) * 100;

                // Create year container
                const yearContainer = document.createElement('div');
                yearContainer.className = 'timeline-year-container';
                yearContainer.style.position = 'absolute';
                yearContainer.style.bottom = '0';
                yearContainer.style.left = `${position}%`;
                yearContainer.style.transform = 'translateX(-50%)';
                yearContainer.style.display = 'flex';
                yearContainer.style.flexDirection = 'column';
                yearContainer.style.alignItems = 'center';
                yearContainer.style.zIndex = coinsInYear.length;

                // Create stacked bars
                const barContainer = document.createElement('div');
                barContainer.className = 'timeline-bar-container';
                barContainer.style.display = 'flex';
                barContainer.style.flexDirection = 'column-reverse';
                barContainer.style.alignItems = 'center';
                barContainer.style.height = '60px';

                coinsInYear.forEach((item, coinIndex) => {
                    const bar = document.createElement('div');
                    bar.className = 'timeline-bar';
                    bar.dataset.year = yearNum;
                    bar.dataset.image = item.image; // Use image as unique identifier
                    bar.dataset.coinIndex = coinIndex;
                    bar.dataset.totalCoins = coinsInYear.length;

                    // Calculate bar height
                    const barHeight = Math.max(15, (40 / maxCoinsPerYear) * coinsInYear.length);
                    bar.style.height = `${barHeight}px`;
                    bar.style.width = '20px';
                    bar.style.backgroundColor = getColorForCurrencyType(item.coin.currency_type);
                    bar.style.marginBottom = '1px';
                    bar.style.borderRadius = '2px 2px 0 0';
                    bar.style.cursor = 'pointer';
                    bar.style.transition = 'all 0.2s ease';
                    bar.style.position = 'relative';

                    // Add hover effect
                    bar.addEventListener('mouseover', function () {
                        this.style.transform = 'scale(1.1)';
                        this.style.zIndex = '100';
                    });

                    bar.addEventListener('mouseout', function () {
                        this.style.transform = 'scale(1)';
                        this.style.zIndex = 'auto';
                    });

                    // Create tooltip with coin information
                    const tooltip = document.createElement('div');
                    tooltip.className = 'timeline-tooltip';
                    tooltip.innerHTML = `
                <strong>${yearNum}</strong><br>
                ${item.coin.image.split('.')[0]}<br>
                ${item.coin.currency_type || 'Unknown type'}
            `;
                    bar.appendChild(tooltip);

                    // Click event to display the specific coin
                    bar.addEventListener('click', function () {
                        const imageName = this.dataset.image;

                        // Find the coin index by image name
                        const coinIndex = currentCountryCoins.findIndex(c => c.image === imageName);

                        if (coinIndex !== -1) {
                            // Update the image display using the global function
                            if (window.updateImageFromTimeline) {
                                window.updateImageFromTimeline(coinIndex);
                            }
                        }
                    });

                    barContainer.appendChild(bar);
                });

                yearContainer.appendChild(barContainer);

                // Add year label
                const yearLabel = document.createElement('div');
                yearLabel.className = 'timeline-label';
                yearLabel.textContent = yearNum;
                yearLabel.style.marginTop = '5px';
                yearLabel.style.fontSize = '10px';
                yearLabel.style.fontWeight = 'bold';
                yearContainer.appendChild(yearLabel);

                timelineContainer.appendChild(yearContainer);
            });

            // Add decade labels
            const startDecade = Math.floor(minYear / 10) * 10;
            const endDecade = Math.ceil(maxYear / 10) * 10;

            for (let decade = startDecade; decade <= endDecade; decade += 10) {
                if (decade < minYear || decade > maxYear) continue;

                const position = ((decade - minYear) / yearRange) * 100;

                const label = document.createElement('div');
                label.className = 'timeline-label';
                label.style.position = 'absolute';
                label.style.bottom = '-40px';
                label.style.left = `${position}%`;
                label.style.transform = 'translateX(-50%)';
                label.style.fontSize = '11px';
                label.style.color = '#7f8c8d';
                label.style.fontWeight = '600';
                label.textContent = decade;

                timelineContainer.appendChild(label);
            }

            // Show color legend
            const timelineLegend = document.getElementById('timeline-legend');
            if (timelineLegend) {
                timelineLegend.style.display = 'flex';
            }

            // Store the filtered coins data for timeline interactions
            window.timelineCoinsData = coinsData;
        }

        // Centralized color mapping for currency types
        function getColorForCurrencyType(currencyType) {
            if (!currencyType) return '#95a5a6'; // Default gray

            const type = currencyType.toLowerCase().trim();

            // Consistent color mapping for all visualizations
            if (type.includes('coin')) return '#2ECC71'; // Green for coins
            if (type.includes('paper') || type.includes('bill')) return '#3498db'; // Blue for paper bills
            if (type.includes('antique')) return '#e74c3c'; // Red for antique
            if (type.includes('gold')) return '#FFD700'; // Gold color
            if (type.includes('silver')) return '#C0C0C0'; // Silver color
            if (type.includes('bronze')) return '#CD7F32'; // Bronze color

            return '#95a5a6'; // Default gray for unknown types
        }

        // Use the centralized color mapping (alias for backward compatibility)
        function getColorForCoinType(currencyType) {
            return getColorForCurrencyType(currencyType);
        }


        // Function to create interactive currency type distribution chart
        function createCurrencyDistributionChart(coinsData) {
            const distributionSection = document.getElementById('distribution-section');
            const distributionContainer = document.getElementById('distribution-container');

            distributionContainer.innerHTML = '';

            // Count currency types - Properly handle multiple types per coin with year-based counting
            const typeCount = {};
            let totalItems = 0;

            coinsData.forEach(coin => {
                if (coin.currency_type && coin.currency_type.toLowerCase() !== 'none') {
                    const types = coin.currency_type.split(',').map(t => t.trim().toLowerCase());
                    const yearMultiplier = coin.year && coin.year.trim() !== "" ?
                        Math.max(coin.year.split(',').length, 1) : 1;

                    types.forEach(type => {
                        if (type) {
                            typeCount[type] = (typeCount[type] || 0) + yearMultiplier;
                            totalItems += yearMultiplier;
                        }
                    });
                }
            });

            const types = Object.keys(typeCount);

            if (types.length === 0) {
                distributionSection.style.display = 'none';
                return;
            }

            // Show distribution section
            distributionSection.style.display = 'block';

            // Create chart container with proper layout
            const chartDiv = document.createElement('div');
            chartDiv.className = 'distribution-chart';
            chartDiv.id = 'distribution-pie-chart';
            chartDiv.style.width = '200px';
            chartDiv.style.height = '200px';
            chartDiv.style.margin = '0 auto 20px auto';

            distributionContainer.appendChild(chartDiv);

            // Create legend
            const legendDiv = document.createElement('div');
            legendDiv.className = 'distribution-legend';
            legendDiv.id = 'distribution-legend';
            distributionContainer.appendChild(legendDiv);

            // Colors for chart segments - use centralized color mapping
            const colors = types.map(type => getColorForCurrencyType(type));

            // Store chart data globally for filtering (now supports multiple filters)
            window.distributionData = {
                types: types,
                typeCount: typeCount,
                totalItems: totalItems,
                colors: colors,
                coinsData: coinsData,
                activeFilters: [] // <-- array of active filters (lowercase strings)
            };

            // Render chart
            renderDistributionChart(window.distributionData);

            // Add "Show All" button
            const showAllButton = document.createElement('button');
            showAllButton.className = 'btn';
            showAllButton.style.marginTop = '15px';
            showAllButton.style.width = '100%';
            showAllButton.style.maxWidth = '200px';
            showAllButton.innerHTML = '<i class="fas fa-eye"></i> Show All Types';
            showAllButton.addEventListener('click', () => {
                // Clear filters
                window.distributionData.activeFilters = [];
                renderDistributionChart(window.distributionData);
                // Reset filters across gallery/timeline
                currentCountryCoins = window.distributionData.coinsData;
                createTimelineVisualization(currentCountryCoins);
                const queryParams = new URLSearchParams(window.location.search);
                const countryQuery = queryParams.get("country");
                if (countryQuery) {
                    updateGalleryViewWithFilter(countryQuery.toLowerCase(), currentCountryCoins);
                    updateImageDisplay(0, currentCountryCoins);
                }
            });

            const buttonContainer = document.createElement('div');
            buttonContainer.style.textAlign = 'center';
            buttonContainer.style.width = '100%';
            buttonContainer.appendChild(showAllButton);
            distributionContainer.appendChild(buttonContainer);
        }


        // Function to render the distribution chart with proper legends and clickable slices
        function renderDistributionChart(data) {
            const chartDiv = document.getElementById('distribution-pie-chart');
            const legendDiv = document.getElementById('distribution-legend');

            // Defensive check
            if (!chartDiv || !legendDiv || !data) return;

            chartDiv.innerHTML = '';
            legendDiv.innerHTML = '';

            // Clear any existing segment overlays
            chartDiv.style.background = '';
            chartDiv.style.position = 'relative';

            let conicGradient = '';
            let cumulativePercentage = 0;
            const segments = [];

            const activeFilters = data.activeFilters || [];
            const hasFilter = activeFilters.length > 0;

            // First pass: calculate segments and create gradient
            data.types.forEach((type, index) => {
                const percentage = (data.typeCount[type] / data.totalItems) * 100;
                const color = data.colors[index % data.colors.length];
                const isActive = !hasFilter || activeFilters.includes(type);

                const start = cumulativePercentage;
                const end = cumulativePercentage + percentage;

                if (conicGradient) {
                    conicGradient += `, ${isActive ? color : '#cccccc'} ${start}% ${end}%`;
                } else {
                    conicGradient = `${isActive ? color : '#cccccc'} ${start}% ${end}%`;
                }

                segments.push({
                    type: type,
                    start: start,
                    end: end,
                    percentage: percentage,
                    color: color,
                    isActive: isActive,
                    index: index
                });

                cumulativePercentage = end;
            });

            // Apply the gradient to the chart
            chartDiv.style.background = `conic-gradient(${conicGradient})`;
            chartDiv.style.borderRadius = '50%';
            chartDiv.style.position = 'relative';
            chartDiv.style.width = '200px';
            chartDiv.style.height = '200px';

            // Second pass: create clickable segment overlays and legends
            segments.forEach(segment => {
                const { type, start, end, percentage, color, isActive, index } = segment;

                // Create clickable segment overlay
                const segmentOverlay = document.createElement('div');
                segmentOverlay.className = 'chart-segment-overlay';
                segmentOverlay.style.position = 'absolute';
                segmentOverlay.style.top = '0';
                segmentOverlay.style.left = '0';
                segmentOverlay.style.width = '100%';
                segmentOverlay.style.height = '100%';
                segmentOverlay.style.borderRadius = '50%';

                // Create clip path for this specific segment
                const startAngle = start * 3.6;
                const endAngle = end * 3.6;
                segmentOverlay.style.clipPath = `conic-gradient(from ${startAngle}deg, #0000 0deg, #0000 ${percentage * 3.6}deg, #000 ${percentage * 3.6}deg)`;

                segmentOverlay.style.cursor = 'pointer';
                segmentOverlay.style.zIndex = '2';
                segmentOverlay.style.opacity = '0';
                segmentOverlay.title = `Click to toggle ${type}`;

                // Use let to create block-scoped variable
                let currentType = type;

                // Add click event - use the block-scoped variable
                segmentOverlay.addEventListener('click', function (e) {
                    e.stopPropagation();
                    console.log('Chart slice clicked - currentType:', currentType);
                    filterByCurrencyType(currentType);
                });

                // Add hover effects
                segmentOverlay.addEventListener('mouseenter', function () {
                    this.style.opacity = '0.1';
                    this.style.backgroundColor = color;
                });

                segmentOverlay.addEventListener('mouseleave', function () {
                    this.style.opacity = '0';
                    this.style.backgroundColor = 'transparent';
                });

                chartDiv.appendChild(segmentOverlay);

                // Create legend item
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.style.cursor = 'pointer';
                legendItem.style.opacity = isActive ? '1' : '0.5';
                legendItem.style.transition = 'all 0.3s ease';
                legendItem.style.padding = '4px 8px';
                legendItem.style.borderRadius = '4px';
                legendItem.style.marginBottom = '5px';
                legendItem.style.border = data.activeFilters.includes(type) ? '2px solid #2c3e50' : '1px solid #e0e0e0';
                legendItem.style.backgroundColor = data.activeFilters.includes(type) ? '#f8f9fa' : 'transparent';

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = isActive ? getColorForCurrencyType(type) : '#cccccc';
                colorBox.style.width = '20px';
                colorBox.style.height = '20px';
                colorBox.style.borderRadius = '4px';
                colorBox.style.marginRight = '10px';
                colorBox.style.flexShrink = '0';
                colorBox.style.transition = 'all 0.3s ease';

                const label = document.createElement('span');
                const formattedType = formatCurrencyType(type);
                label.textContent = `${formattedType}: ${data.typeCount[type]} items`;
                label.style.fontWeight = data.activeFilters.includes(type) ? 'bold' : 'normal';
                label.style.fontSize = '14px';
                label.style.flex = '1';

                const percentageText = document.createElement('span');
                percentageText.textContent = `(${((data.typeCount[type] / data.totalItems) * 100).toFixed(1)}%)`;
                percentageText.style.fontSize = '12px';
                percentageText.style.color = '#666';
                percentageText.style.marginLeft = '8px';

                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                legendItem.appendChild(percentageText);

                // Make legend item layout flexible
                legendItem.style.display = 'flex';
                legendItem.style.alignItems = 'center';
                legendItem.style.justifyContent = 'flex-start';

                // Use let for legend type too
                let legendType = type;

                // Add click event to legend item
                legendItem.addEventListener('click', function (e) {
                    console.log('Legend item clicked - legendType:', legendType);
                    filterByCurrencyType(legendType);
                });

                legendItem.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateX(5px)';
                    this.querySelector('.legend-color').style.transform = 'scale(1.1)';
                });

                legendItem.addEventListener('mouseleave', function () {
                    this.style.transform = 'translateX(0)';
                    this.querySelector('.legend-color').style.transform = 'scale(1)';
                });

                legendDiv.appendChild(legendItem);
            });

            // Add center text for total or selected total
            const centerText = document.createElement('div');
            centerText.style.position = 'absolute';
            centerText.style.top = '50%';
            centerText.style.left = '50%';
            centerText.style.transform = 'translate(-50%, -50%)';
            centerText.style.textAlign = 'center';
            centerText.style.fontWeight = 'bold';
            centerText.style.fontSize = data.activeFilters.length ? '18px' : '20px';
            centerText.style.color = data.activeFilters.length ? '#e74c3c' : '#2c3e50';
            centerText.style.background = 'white';
            centerText.style.borderRadius = '50%';
            centerText.style.width = '60px';
            centerText.style.height = '60px';
            centerText.style.display = 'flex';
            centerText.style.alignItems = 'center';
            centerText.style.justifyContent = 'center';
            centerText.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';

            // Compute selected total when filters active
            let centerValue = data.totalItems;
            if (data.activeFilters && data.activeFilters.length > 0) {
                centerValue = data.activeFilters.reduce((sum, f) => sum + (data.typeCount[f] || 0), 0);
            }
            centerText.textContent = centerValue;
            centerText.title = data.activeFilters && data.activeFilters.length > 0 ?
                `Showing ${centerValue} items (${data.activeFilters.join(', ')})` : 'Showing all types';
            centerText.style.zIndex = '1';

            chartDiv.appendChild(centerText);
        }


        // Replace the segments.forEach loop with this:
        function createChartSegment(segment) {
            const { type, start, end, percentage, color, isActive, index } = segment;

            // Create clickable segment overlay
            const segmentOverlay = document.createElement('div');
            segmentOverlay.className = 'chart-segment-overlay';
            segmentOverlay.style.position = 'absolute';
            segmentOverlay.style.top = '0';
            segmentOverlay.style.left = '0';
            segmentOverlay.style.width = '100%';
            segmentOverlay.style.height = '100%';
            segmentOverlay.style.borderRadius = '50%';

            const startAngle = start * 3.6;
            const endAngle = end * 3.6;
            segmentOverlay.style.clipPath = `conic-gradient(from ${startAngle}deg, #0000 0deg, #0000 ${percentage * 3.6}deg, #000 ${percentage * 3.6}deg)`;

            segmentOverlay.style.cursor = 'pointer';
            segmentOverlay.style.zIndex = '2';
            segmentOverlay.style.opacity = '0';
            segmentOverlay.title = `Click to toggle ${type}`;

            // Add click event
            segmentOverlay.addEventListener('click', function (e) {
                e.stopPropagation();
                console.log('Chart slice clicked - type:', type);
                filterByCurrencyType(type);
            });

            // Add hover effects
            segmentOverlay.addEventListener('mouseenter', function () {
                this.style.opacity = '0.1';
                this.style.backgroundColor = color;
            });

            segmentOverlay.addEventListener('mouseleave', function () {
                this.style.opacity = '0';
                this.style.backgroundColor = 'transparent';
            });

            document.getElementById('distribution-pie-chart').appendChild(segmentOverlay);
        }

        function createLegendItem(segment, data) {
            const { type, color, isActive } = segment;

            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.style.cursor = 'pointer';
            legendItem.style.opacity = isActive ? '1' : '0.5';
            legendItem.style.transition = 'all 0.3s ease';
            legendItem.style.padding = '4px 8px';
            legendItem.style.borderRadius = '4px';
            legendItem.style.marginBottom = '5px';
            legendItem.style.border = data.activeFilters.includes(type) ? '2px solid #2c3e50' : '1px solid #e0e0e0';
            legendItem.style.backgroundColor = data.activeFilters.includes(type) ? '#f8f9fa' : 'transparent';

            const colorBox = document.createElement('div');
            colorBox.className = 'legend-color';
            colorBox.style.backgroundColor = isActive ? color : '#cccccc';
            colorBox.style.width = '20px';
            colorBox.style.height = '20px';
            colorBox.style.borderRadius = '4px';
            colorBox.style.marginRight = '10px';
            colorBox.style.flexShrink = '0';
            colorBox.style.transition = 'all 0.3s ease';

            const label = document.createElement('span');
            const formattedType = formatCurrencyType(type);
            label.textContent = `${formattedType}: ${data.typeCount[type]} items`;
            label.style.fontWeight = data.activeFilters.includes(type) ? 'bold' : 'normal';
            label.style.fontSize = '14px';
            label.style.flex = '1';

            const percentageText = document.createElement('span');
            percentageText.textContent = `(${((data.typeCount[type] / data.totalItems) * 100).toFixed(1)}%)`;
            percentageText.style.fontSize = '12px';
            percentageText.style.color = '#666';
            percentageText.style.marginLeft = '8px';

            legendItem.appendChild(colorBox);
            legendItem.appendChild(label);
            legendItem.appendChild(percentageText);

            legendItem.style.display = 'flex';
            legendItem.style.alignItems = 'center';
            legendItem.style.justifyContent = 'flex-start';

            // Add click event to legend item
            legendItem.addEventListener('click', function (e) {
                console.log('Legend item clicked - type:', type);
                filterByCurrencyType(type);
            });

            legendItem.addEventListener('mouseenter', function () {
                this.style.transform = 'translateX(5px)';
                this.querySelector('.legend-color').style.transform = 'scale(1.1)';
            });

            legendItem.addEventListener('mouseleave', function () {
                this.style.transform = 'translateX(0)';
                this.querySelector('.legend-color').style.transform = 'scale(1)';
            });

            document.getElementById('distribution-legend').appendChild(legendItem);
        }

        // Then call these functions for each segment
        segments.forEach(segment => {
            createChartSegment(segment);
            createLegendItem(segment, data);
        });


        // Helper function to format currency type names
        function formatCurrencyType(type) {
            if (!type) return 'Unknown';

            return type.split('-').map(word => {
                if (word === 'paper') return 'Paper';
                if (word === 'bill') return 'Bill';
                if (word === 'coin') return 'Coin';
                if (word === 'antique') return 'Antique';
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }

        // Function to filter by currency type (supports multiple toggles)
        function filterByCurrencyType(type) {
            if (!window.distributionData) return;

            console.log('Filtering by type:', type); // Debug log

            // Ensure type is properly normalized (trimmed and lowercase)
            const normalizedType = (type || '').toLowerCase().trim();
            const activeFilters = window.distributionData.activeFilters || [];

            console.log('Normalized type:', normalizedType); // Debug log
            console.log('Current active filters:', activeFilters); // Debug log

            if (activeFilters.includes(normalizedType)) {
                // Toggle off
                window.distributionData.activeFilters = activeFilters.filter(f => f !== normalizedType);
            } else {
                // Toggle on
                window.distributionData.activeFilters = [...activeFilters, normalizedType];
            }

            console.log('New active filters:', window.distributionData.activeFilters); // Debug log

            // Re-render chart with new filter state
            renderDistributionChart(window.distributionData);

            // Filter the coins data for timeline and gallery
            const filters = window.distributionData.activeFilters || [];
            const filteredCoins = (filters.length > 0) ?
                window.distributionData.coinsData.filter(coin => {
                    if (!coin.currency_type) return false;
                    const types = coin.currency_type.split(',').map(x => x.trim().toLowerCase());
                    // include coin if any of its types is in active filters
                    return types.some(tt => filters.includes(tt));
                }) :
                window.distributionData.coinsData;

            // Update currentCountryCoins with filtered data for navigation
            currentCountryCoins = filteredCoins;

            // Update timeline with filtered data
            createTimelineVisualization(filteredCoins);

            // Update gallery view with filtered data (if a country is selected)
            const queryParams = new URLSearchParams(window.location.search);
            const countryQuery = queryParams.get("country");
            if (countryQuery) {
                updateGalleryViewWithFilter(countryQuery.toLowerCase(), filteredCoins);
            }

            // Update the main image display if current image doesn't match filter
            if (filters.length > 0 && filteredCoins.length > 0) {
                const currentImageSrc = document.getElementById("current-image-img").src;
                const currentImageName = currentImageSrc.split('/').pop();

                const currentCoinIndex = filteredCoins.findIndex(coin =>
                    coin.image === currentImageName
                );

                if (currentCoinIndex === -1) {
                    // Current image is not in filtered results, show first filtered image
                    updateImageDisplay(0, filteredCoins);
                }
            } else if (filteredCoins.length > 0) {
                // Show all types, ensure we're showing a valid image
                updateImageDisplay(0, filteredCoins);
            }
        }


        // Ensure consistent colors across all visualizations
        function ensureColorConsistency() {
            // This function can be called to verify colors are consistent
            const testTypes = ['coin', 'paper-bill', 'antique', 'gold coin', 'silver coin'];

            console.log('Color consistency check:');
            testTypes.forEach(type => {
                console.log(`${type}: ${getColorForCurrencyType(type)}`);
            });
        }

        // Call this during development to verify colors
        // ensureColorConsistency();

        // Helper function to update image display
        function updateImageDisplay(index, coinsArray) {
            if (coinsArray.length === 0) return;

            const coin = coinsArray[index];
            const countryName = coin.country.toLowerCase();
            const imagePath = `images/${toTitleCase(countryName)}/${coin.image}`;

            // Update thumbnails
            const thumbnailContainer = document.getElementById("thumbnail-container");
            thumbnailContainer.innerHTML = "";

            coinsArray.forEach((coin, idx) => {
                const thumbnail = document.createElement("img");
                thumbnail.src = `images/${toTitleCase(countryName)}/${coin.image}`;
                thumbnail.alt = `Thumbnail ${idx + 1}`;
                thumbnail.loading = "lazy";
                if (idx === index) {
                    thumbnail.classList.add('active-thumbnail');
                }
                thumbnail.addEventListener("click", () => {
                    updateImageDisplay(idx, coinsArray);
                });
                thumbnailContainer.appendChild(thumbnail);
            });

            // Update main image and details
            const countryInfo = fetchCountryInfo(countryName);
            setCurrentImage(
                imagePath,
                coin.note,
                coin.donor_name,
                coin.currency_type,
                countryInfo,
                coin.year,
                coin.size,
                index
            );

            currentImageIndex = index;

            // FIX: Update URL
            updateURLWithCurrentCoin();
        }

        // Function to update gallery view with filtered data
        function updateGalleryViewWithFilter(countryName, filteredCoins) {
            const galleryGrid = document.getElementById('gallery-grid-container');
            const sortBySelect = document.getElementById('sort-by');
            galleryGrid.innerHTML = '';

            if (!filteredCoins || filteredCoins.length === 0) {
                galleryGrid.innerHTML = '<p style="text-align: center; color: var(--secondary-color);">No items found for this currency type.</p>';
                return;
            }

            let sortedCoins = [...filteredCoins];
            const sortValue = sortBySelect.value;

            if (sortValue === 'name-asc') {
                sortedCoins.sort((a, b) => a.image.localeCompare(b.image));
            } else if (sortValue === 'name-desc') {
                sortedCoins.sort((a, b) => b.image.localeCompare(b.image));
            } else if (sortValue === 'type') {
                sortedCoins.sort((a, b) => (a.currency_type || '').localeCompare(b.currency_type || ''));
            }

            sortedCoins.forEach((coin, index) => {
                const galleryItem = document.createElement('div');
                galleryItem.classList.add('gallery-item');
                const imageUrl = `images/${toTitleCase(countryName)}/${coin.image}`;
                galleryItem.dataset.imageUrl = imageUrl;
                galleryItem.dataset.note = coin.note;
                galleryItem.dataset.donor = coin.donor_name;
                galleryItem.dataset.currencyType = coin.currency_type;

                galleryItem.innerHTML = `
            <img class="gallery-item-image" src="${imageUrl}" alt="${coin.note}" onerror="this.src='https://placehold.co/200x150/cccccc/333333?text=Image+Not+Found'">
            <div class="gallery-item-info">
                <p>${coin.image}</p>
                <p style="font-size: 10px; color: #666; margin-top: 5px;">${coin.currency_type || 'Unknown'}</p>
            </div>
        `;

                galleryItem.addEventListener('click', function () {
                    const countryInfo = fetchCountryInfo(countryName);
                    openImageModal(
                        imageUrl,
                        coin.note,
                        countryInfo.name,
                        countryInfo.capital,
                        countryInfo.currency?.name,
                        index,
                        coin.donor_name
                    );
                    // Update currentCountryCoins to filtered set for modal navigation
                    currentCountryCoins = sortedCoins;
                    currentImageIndex = index;

                    // FIX: Update URL when clicking gallery items
                    updateURLWithCurrentCoin();
                });

                galleryGrid.appendChild(galleryItem);
            });

            // Update the thumbnail container as well
            updateThumbnailsWithFilter(countryName, sortedCoins);
        }

        // Function to update thumbnails with filtered data
        function updateThumbnailsWithFilter(countryName, filteredCoins) {
            const thumbnailContainer = document.getElementById("thumbnail-container");
            thumbnailContainer.innerHTML = "";

            filteredCoins.forEach((coin, index) => {
                const thumbnail = document.createElement("img");
                thumbnail.src = `images/${toTitleCase(countryName)}/${coin.image}`;
                thumbnail.alt = `Thumbnail ${index + 1}`;
                thumbnail.loading = "lazy";
                thumbnail.onerror = function () {
                    this.src = 'https://placehold.co/70x70/cccccc/333333?text=404';
                };

                if (index === currentImageIndex) {
                    thumbnail.classList.add('active-thumbnail');
                }

                thumbnail.addEventListener("click", () => {
                    // Update all thumbnails
                    document.querySelectorAll('.img-queue-in img').forEach(img => {
                        img.classList.remove('active-thumbnail');
                    });
                    thumbnail.classList.add('active-thumbnail');

                    // Update main display
                    updateImageDisplay(index, filteredCoins);

                    // URL update is handled inside updateImageDisplay
                });

                thumbnailContainer.appendChild(thumbnail);
            });
        }

        function debugFilterState() {
            console.log('Active Filters:', window.distributionData?.activeFilters);
            console.log('Available Types:', window.distributionData?.types);
            console.log('Type Counts:', window.distributionData?.typeCount);
        }

        // Suppress "Invalid LatLng" errors
        const origConsoleError = console.error;
        console.error = function (...args) {
            if (args[0] && args[0].toString().includes("Invalid LatLng object")) {
                // Ignore these
                return;
            }
            origConsoleError.apply(console, args);
        };


    </script>

    <script>
        // Suppress "Invalid LatLng object" errors thrown by Leaflet
        (function () {
            const origOnError = window.onerror;
            window.onerror = function (msg, url, lineNo, columnNo, error) {
                if (msg && msg.toString().includes("Invalid LatLng object")) {
                    // Ignore these map errors
                    return true; // prevent logging in console
                }
                if (origOnError) return origOnError(msg, url, lineNo, columnNo, error);
            };

            const origConsoleError = console.error;
            console.error = function (...args) {
                if (args[0] && args[0].toString().includes("Invalid LatLng object")) {
                    // Ignore console.error messages too
                    return;
                }
                origConsoleError.apply(console, args);
            };
        })();
    </script>
    <script>
        // Suppress "Invalid LatLng object" and "Error loading continent map" errors
        (function () {
            const origOnError = window.onerror;
            window.onerror = function (msg, url, lineNo, columnNo, error) {
                if (msg && msg.toString().includes("Invalid LatLng object")) {
                    return true; // swallow error
                }
                if (origOnError) return origOnError(msg, url, lineNo, columnNo, error);
            };

            const origConsoleError = console.error;
            console.error = function (...args) {
                const joined = args.map(a => (a && a.toString ? a.toString() : '')).join(' ');
                if (joined.includes("Invalid LatLng object") || joined.includes("Error loading continent map")) {
                    // hide these specific errors
                    return;
                }
                origConsoleError.apply(console, args);
            };
        })();

        // Helper function to update URL with current country and coin
        function updateURLWithCurrentCoin() {
            if (currentCountryCoins.length === 0 || currentImageIndex === undefined) return;

            const queryParams = new URLSearchParams(window.location.search);
            const country = queryParams.get("country");
            const currentCoin = currentCountryCoins[currentImageIndex];

            if (country && currentCoin) {
                const cleanCoinName = currentCoin.image.split('.')[0];
                const newUrl = `?country=${country}&coin=${cleanCoinName}`;
                history.replaceState(null, "", newUrl);
            }
        }
    </script>

</body>

</html>