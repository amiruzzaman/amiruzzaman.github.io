<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grading Rubric Tool</title>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="#">
    <style>
        /* Basic table styling */
        table,
        th,
        td {
            border: solid 1px #ddd;
            border-collapse: collapse;
            padding: 2px 3px;
            text-align: center;
            width: 30px;
        }

        th {
            font-weight: bold;
        }

        /* Notice box styling */
        #notice {
            width: 80%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 5px;
            background-color: #f0f0f0;
            border: 1px solid #e0e0e0;
            overflow: auto;
            font-family: Arial, sans-serif;
            color: red;
            font-weight: normal;
            font-size: 14px;
        }

        /* Page layout */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }

        html {
            overflow-y: scroll;
            height: 100%;
        }

        /* Main container */
        #container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            overflow: auto;
            padding-bottom: 50px;
        }

        #overlay {
            visibility: hidden;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Output textarea */
        #paraID {
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Rubric item styling */
        .item-container {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .item-yes,
        .item-no {
            padding: 8px;
            margin: 2px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            transition: all 0.2s;
        }

        .item-yes {
            background-color: #f8f8f8;
        }

        .item-no {
            background-color: #f8f8f8;
        }

        .item-yes.selected {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .item-no.selected {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .item-score {
            width: 40px;
            text-align: center;
            font-weight: bold;
            margin-left: 10px;
        }

        .sub-total-score {
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            padding: 5px;
            background-color: #e9ecef;
            border-radius: 4px;
            text-align: right;
        }

        .problem-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }

        .part-container {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .save-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        .save-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .item-textareabox {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        .total-score-display {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .unselected-highlight {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 152, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }
    </style>

    <style>
        /* Edit modal styling */
        #edit-box {
            visibility: hidden;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 400px;
            max-width: 90vw;
            border-radius: 8px;
        }

        #edit-text {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            font-family: Arial, sans-serif;
            font-size: 14px;
            box-sizing: border-box;
        }

        #edit-score-container {
            margin-bottom: 15px;
        }

        #edit-score-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        #edit-score {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        #edit-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        #edit-buttons button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            min-width: 100px;
            transition: background-color 0.2s;
        }

        #edit-clear {
            background-color: #f8f9fa;
            color: #212529;
            border: 1px solid #ced4da;
        }

        #edit-clear:hover {
            background-color: #e2e6ea;
        }

        #edit-zero {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        #edit-zero:hover {
            background-color: #ffe8a1;
        }

        #edit-cancel {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #edit-cancel:hover {
            background-color: #f1b0b7;
        }

        #edit-save {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #edit-save:hover {
            background-color: #c1e5c8;
        }
    </style>
</head>

<body>
    <!-- Total score display -->
    <div class="total-score-display" id="totalScoreDisplay">Total: 0/0</div>

    <!-- Instructions notice -->
    <p id="notice">Click to select "Yes" (green) or "No" (red) for each item. "No" selections default to 0 points but
        can be adjusted by double-clicking. Scores update automatically.</p>

    <!-- Main content container -->
    <div id="container"></div>

    <!-- Edit modal (hidden by default) -->
    <div id="edit-box">
        <textarea id="edit-text"></textarea>
        <div id="edit-score-container">
            <label for="edit-score">Score</label>
            <input id="edit-score" type="number" />
        </div>
        <div id="edit-buttons">
            <button id="edit-clear">Clear Comment</button>
            <button id="edit-zero">Set to 0</button>
            <button id="edit-cancel">Cancel</button>
            <button id="edit-save">Save</button>
        </div>
    </div>

    <!-- Modal overlay -->
    <div id="overlay"></div>
    <p id="notice" style="height: 30px;"></p>

    <script>
        // Global variables
        let selectedItem = null;
        let subTotalScoreArr = [];
        let sarr = [];
        let allItems = [];
        let maxPossibleScore = 0;
        let saveButton;

        /**
         * Checks if all items are selected (either Yes or No)
         * @returns {boolean} - True if all items are selected, false otherwise
         */
        function allItemsSelected() {
            const allYesNoItems = document.querySelectorAll('.item-yes, .item-no');
            for (let item of allYesNoItems) {
                if (!item.classList.contains('selected')) {
                    return false;
                }
            }
            return true;
        }

        /**
         * Finds the first unselected item and scrolls to it
         * @returns {HTMLElement|null} - The first unselected item or null if all are selected
         */
        function findAndScrollToFirstUnselected() {
            const allYesNoItems = document.querySelectorAll('.item-yes, .item-no');
            for (let item of allYesNoItems) {
                if (!item.classList.contains('selected')) {
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    item.classList.add('unselected-highlight');
                    setTimeout(() => {
                        item.classList.remove('unselected-highlight');
                    }, 2000);
                    return item;
                }
            }
            return null;
        }

        /**
         * Updates the save button state based on selection completeness
         */
        function updateSaveButtonState() {
            if (saveButton) {
                saveButton.disabled = !allItemsSelected();
                saveButton.title = saveButton.disabled ?
                    "Please select all items (Yes or No) before saving" :
                    "Save your grading results";
            }
        }

        /**
     * Handles selection of an item and moves to next unselected if needed
     * @param {HTMLElement} selectedElement - The element that was just selected
     */
        function handleSelection(selectedElement) {
            updateAllScores();
            updateSaveButtonState();

            // Only scroll if not all items are selected yet
            if (!allItemsSelected()) {
                setTimeout(() => {
                    // Find the next unselected item AFTER the current one
                    const allItems = Array.from(document.querySelectorAll('.item-yes, .item-no'));
                    const currentIndex = allItems.indexOf(selectedElement);
                    let nextUnselected = null;

                    // Check items after the current one first
                    for (let i = currentIndex + 1; i < allItems.length; i++) {
                        if (!allItems[i].classList.contains('selected')) {
                            nextUnselected = allItems[i];
                            break;
                        }
                    }

                    // If nothing found after, check from beginning
                    if (!nextUnselected) {
                        for (let i = 0; i < currentIndex; i++) {
                            if (!allItems[i].classList.contains('selected')) {
                                nextUnselected = allItems[i];
                                break;
                            }
                        }
                    }

                    if (nextUnselected) {
                        nextUnselected.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        nextUnselected.classList.add('unselected-highlight');
                        setTimeout(() => {
                            nextUnselected.classList.remove('unselected-highlight');
                        }, 2000);
                    }
                }, 300);
            }
        }

        /**
         * Opens the edit modal for the selected rubric item
         */
        function editItem() {
            const editBox = document.getElementById('edit-box');
            const editText = document.getElementById('edit-text');
            const editScore = document.getElementById('edit-score');
            const overlay = document.getElementById('overlay');

            editText.value = selectedItem.innerText;
            editScore.value = selectedItem.getAttribute('score');

            editBox.style.visibility = 'visible';
            overlay.style.visibility = 'visible';
        }

        /**
         * Checks if all items in a container are selected as Yes or No
         * @param {HTMLElement} container - The container to check
         * @returns {Object} - {allYes: boolean, allNo: boolean}
         */
        function checkAllSelected(container) {
            const yesItems = container.querySelectorAll('.item-yes.selected');
            const noItems = container.querySelectorAll('.item-no.selected');
            const allItems = container.querySelectorAll('.item-container');

            return {
                allYes: yesItems.length === allItems.length,
                allNo: noItems.length === allItems.length
            };
        }

        /**
         * Calculates and updates all scores in the rubric
         */
        function updateAllScores() {
            subTotalScoreArr = [];
            sarr = [];
            let totalScore = 0;
            maxPossibleScore = 0;

            const partContainers = document.querySelectorAll('.part-container');

            partContainers.forEach(part => {
                let partTotal = 0;
                let partScore = 0;

                const problemContainers = part.querySelectorAll('.problem-container');

                problemContainers.forEach(problem => {
                    let problemTotal = 0;
                    let problemScore = 0;

                    const items = problem.querySelectorAll('.item-container');

                    items.forEach(item => {
                        const itemYes = item.querySelector('.item-yes');
                        const itemNo = item.querySelector('.item-no');
                        const itemScoreElement = item.querySelector('.item-score');
                        const maxScore = parseInt(itemYes.getAttribute('score'));

                        problemTotal += maxScore;
                        maxPossibleScore += maxScore;

                        let actualScore = 0;
                        if (itemYes.classList.contains('selected')) {
                            actualScore = maxScore;
                        } else if (itemNo.classList.contains('selected')) {
                            actualScore = parseInt(itemNo.getAttribute('score')) || 0;
                        }

                        itemScoreElement.textContent = actualScore;
                        problemScore += actualScore;
                        totalScore += actualScore;
                    });

                    const subTotalDiv = problem.querySelector('.sub-total-score');
                    if (subTotalDiv) {
                        subTotalDiv.textContent = `Subtotal: ${problemScore}/${problemTotal}`;
                    }

                    partTotal += problemTotal;
                    partScore += problemScore;
                });

                subTotalScoreArr.push(partTotal);
                sarr.push(partScore);
            });

            document.getElementById('totalScoreDisplay').textContent = `Total: ${totalScore}/${maxPossibleScore}`;
        }

        /**
         * Renders a problem section with its yes/no options
         * @param {HTMLElement} container - The parent container
         * @param {Array} problems - Array of problem objects
         */
        function renderProblem(container, problems) {
            let subTotal = 0;
            let subScoreArr = [];
            let subTotalDiv = document.createElement('div');

            for (let problem of problems) {
                const { yes, no, point: score } = problem;

                const itemContainer = document.createElement('div');
                itemContainer.classList.add('item-container');

                const itemYes = document.createElement('div');
                itemYes.classList.add('item-yes');
                itemYes.setAttribute('score', score);
                itemYes.innerText = yes;

                const itemNo = document.createElement('div');
                itemNo.classList.add('item-no');
                itemNo.setAttribute('score', 0);
                itemNo.innerText = no;

                const itemScore = document.createElement('div');
                itemScore.classList.add('item-score');
                itemScore.innerHTML = '0';
                itemScore.style.color = 'red';

                subTotal += parseInt(score);
                subScoreArr.push(0);

                allItems.push({
                    yes: itemYes,
                    no: itemNo,
                    score: itemScore,
                    maxScore: score
                });

                itemYes.addEventListener('click', (e) => {
                    const container = e.currentTarget.closest('.problem-container');
                    const selectionState = checkAllSelected(container);

                    if (selectionState.allYes) {
                        return;
                    }

                    itemYes.classList.add('selected');
                    itemNo.classList.remove('selected');
                    itemNo.setAttribute('score', 0);
                    itemScore.textContent = itemYes.getAttribute('score');
                    itemScore.style.color = 'green';
                    handleSelection(itemYes);
                });
                itemYes.addEventListener('dblclick', function () {
                    selectedItem = this;
                    editItem();
                });

                itemNo.addEventListener('click', (e) => {
                    const container = e.currentTarget.closest('.problem-container');
                    const selectionState = checkAllSelected(container);

                    if (selectionState.allNo) {
                        return;
                    }

                    itemNo.classList.add('selected');
                    itemYes.classList.remove('selected');
                    itemScore.textContent = itemNo.getAttribute('score') || '0';
                    itemScore.style.color = 'red';
                    handleSelection(itemNo);
                });
                itemNo.addEventListener('dblclick', function () {
                    selectedItem = this;
                    editItem();
                });

                itemContainer.append(itemYes, itemNo, itemScore);
                container.appendChild(itemContainer);
            }

            subTotalDiv.innerHTML = `Subtotal: 0/${subTotal}`;
            subTotalScoreArr.push(subTotal);
            subTotalDiv.style.color = 'green';
            subTotalDiv.style.fontSize = "14px";
            subTotalDiv.classList.add('sub-total-score');
            container.appendChild(subTotalDiv);
        }

        // Load rubric data and initialize the page
        fetch('a4sp25.json')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('container');
                const parts = Object.keys(data);

                for (let part of parts) {
                    const partContainer = document.createElement('div');
                    partContainer.classList.add('part-container');

                    const partTitle = data[part].title;
                    const partProblems = data[part].problems;

                    const h3 = document.createElement('h3');
                    h3.innerText = `${part}: ${partTitle}`;
                    partContainer.appendChild(h3);

                    if (partProblems.length > 1) {
                        for (let i = 0; i < partProblems.length; i++) {
                            const problemContainer = document.createElement('div');
                            problemContainer.classList.add('problem-container');

                            const problemTitle = `Problem ${i + 1}`;
                            const h4 = document.createElement('h4');
                            h4.innerText = problemTitle;
                            problemContainer.appendChild(h4);

                            const problemList = partProblems[i];
                            renderProblem(problemContainer, problemList);
                            partContainer.appendChild(problemContainer);
                        }
                    } else {
                        const problemContainer = document.createElement('div');
                        problemContainer.classList.add('problem-container');
                        const problemList = partProblems[0];
                        renderProblem(problemContainer, problemList);
                        partContainer.appendChild(problemContainer);
                    }

                    container.appendChild(partContainer);
                }

                saveButton = document.createElement('button');
                saveButton.classList.add('save-button');
                saveButton.innerText = 'Save';
                saveButton.disabled = true;
                saveButton.title = "Please select all items (Yes or No) before saving";

                const commentDiv = document.createElement('div');
                commentDiv.innerHTML = "Overall";
                const textAreaDiv = document.createElement('div');
                const input = document.createElement("textarea");
                input.name = "post";
                input.maxLength = "5000";
                input.cols = "80";
                input.rows = "5";
                input.classList.add('item-textareabox');
                textAreaDiv.classList.add('item-textarea');
                input.value = "Overall: Your assignment report is off to a good start. There are a few sections that require more attention. Please refer to the comment/feedback above for further details.";
                textAreaDiv.appendChild(input);

                const inputTxt = document.createElement("input");
                inputTxt.type = "text";
                const fileNameLabel = document.createElement('div');
                fileNameLabel.innerHTML = "Filename";

                const lastDiv = document.createElement('div');
                lastDiv.style.height = '100px';
                lastDiv.innerText = 'Final grade by item will appear below';
                lastDiv.style.color = "green";

                const para = document.createElement('textarea');
                para.id = "paraID";

                const checkBoxDiv = document.createElement('div');
                checkBoxDiv.classList.add('checkbox-container');
                const checkBox = document.createElement('input');
                checkBox.type = 'checkbox';
                checkBox.id = 'additional-comment';
                const checkBoxLabel = document.createElement('label');
                checkBoxLabel.innerHTML = 'Include additional comment about page management!';
                checkBoxLabel.htmlFor = 'additional-comment';
                checkBoxDiv.append(checkBox, checkBoxLabel);
                container.appendChild(checkBoxDiv);

                saveButton.addEventListener('click', () => {
                    if (!allItemsSelected()) {
                        alert('Please select all items (Yes or No) before saving.');
                        findAndScrollToFirstUnselected();
                        return;
                    }

                    let text = '';
                    let score = 0;
                    let titlearr = [];
                    let jsonData = {};

                    const parts = document.querySelectorAll('.part-container');
                    parts.forEach(part => {
                        const title = part.querySelector('h3').innerText;
                        text += `${title}\n`;
                        titlearr.push(title);

                        const problems = part.querySelectorAll('.problem-container');
                        problems.forEach(problem => {
                            const problemTitle = problem.querySelector('h4');
                            if (problemTitle) {
                                text += `${problemTitle.innerText}: \n`;
                            }

                            let s = 0;
                            const items = problem.querySelectorAll('.item-container');
                            items.forEach(item => {
                                const itemYes = item.querySelector('.item-yes');
                                const itemNo = item.querySelector('.item-no');
                                const itemScore = item.querySelector('.item-score');

                                if (itemYes.classList.contains('selected')) {
                                    text += `${itemYes.innerText} `;
                                    s += parseInt(itemScore.textContent);
                                } else {
                                    text += `${itemNo.innerText} `;
                                    s += parseInt(itemScore.textContent);
                                }
                            });

                            if (problemTitle) {
                                jsonData[title + problemTitle.innerText] = s;
                            } else {
                                jsonData[title] = s;
                            }
                            score += s;
                            text += '\n\n';
                        });
                    });

                    text += input.value + ' ';
                    if (checkBox.checked) {
                        text += "You could have done a better job in managing your empty spaces in your report, which would have allowed you to add more discussions on your results and comparisons.\n";
                    }

                    para.maxLength = "50000";
                    para.cols = "80";
                    para.value = text;
                    text = text.replace("Part 10: EC\n", "");

                    const lines = para.value.split("\n");
                    console.log("number of lines", lines.length);
                    para.rows = lines.length.toString();

                    text += `Total score: ${score}\n`;
                    jsonData['total'] = score;

                    const updatedText = insertScores(text, subTotalScoreArr, sarr);
                    console.log('Updated Text:', updatedText);
                    document.getElementById("paraID").value = "";
                    createTableFromJSON(jsonData);
                    para.value = updatedText;
                });

                container.append(
                    commentDiv,
                    textAreaDiv,
                    fileNameLabel,
                    inputTxt,
                    saveButton,
                    lastDiv,
                    para
                );

                para.onclick = function () { myCopyFunction(para.id) };
                updateAllScores();
            });

        /**
         * Creates a download link for a text file
         * @param {string} filename - Name for the downloaded file
         * @param {string} text - Content of the file
         */
        function download(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        /**
         * Creates an HTML table from JSON data
         * @param {Object} jsonData - The data to display in the table
         */
        function createTableFromJSON(jsonData) {
            const col = [];

            for (const key in jsonData) {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }

            const table = document.createElement("table");
            const tr = table.insertRow(-1);

            for (let i = 0; i < col.length; i++) {
                const th = document.createElement("th");
                th.innerHTML = col[i];
                tr.appendChild(th);
            }

            const dataRow = table.insertRow(-1);
            for (const key in jsonData) {
                const tabCell = dataRow.insertCell(-1);
                tabCell.innerHTML = jsonData[key];
            }

            const container = document.getElementById('container');
            const divContainer = document.createElement('div');
            divContainer.id = "someID";

            const existingTable = document.getElementById("someID");
            if (existingTable) {
                existingTable.innerHTML = "";
            }

            divContainer.style.height = "300px";
            divContainer.innerHTML = "";
            divContainer.appendChild(table);
            container.appendChild(divContainer);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('edit-save').addEventListener('click', () => {
                const editBox = document.getElementById('edit-box');
                const editText = document.getElementById('edit-text');
                const editScore = document.getElementById('edit-score');
                const overlay = document.getElementById('overlay');

                selectedItem.innerText = editText.value;
                selectedItem.setAttribute('score', editScore.value);

                const itemContainer = selectedItem.parentElement;
                const itemScore = itemContainer.querySelector('.item-score');
                if (selectedItem.classList.contains('selected')) {
                    itemScore.textContent = editScore.value;
                    if (selectedItem.classList.contains('item-no')) {
                        itemScore.style.color = 'red';
                    } else {
                        itemScore.style.color = 'green';
                    }
                }

                updateAllScores();
                updateSaveButtonState();

                editBox.style.visibility = 'hidden';
                overlay.style.visibility = 'hidden';
            });

            document.getElementById('edit-cancel').addEventListener('click', () => {
                const editBox = document.getElementById('edit-box');
                const overlay = document.getElementById('overlay');

                editBox.style.visibility = 'hidden';
                overlay.style.visibility = 'hidden';
            });

            document.getElementById('edit-clear').addEventListener('click', () => {
                document.getElementById('edit-text').value = '';
            });

            document.getElementById('edit-zero').addEventListener('click', () => {
                document.getElementById('edit-score').value = '0';
            });

            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('item-yes') || e.target.classList.contains('item-no')) {
                    updateSaveButtonState();
                }
            });
        });

        /**
         * Copies text from the output textarea to clipboard
         * @param {string} id - ID of the textarea element
         */
        function myCopyFunction(id) {
            const para = document.getElementById(id);
            navigator.clipboard.writeText(para.value);
        }

        /**
         * Inserts scores into the output text
         * @param {string} text - The original text
         * @param {Array} subTotalScoreArr - Array of possible scores
         * @param {Array} sarr - Array of actual scores
         * @returns {string} The updated text with scores inserted
         */
        function insertScores(text, subTotalScoreArr, sarr) {
            return text.replace(/(Part (\d+):)(.*?)(?=\n|$)/g, (match, partPrefix, partNumber, title) => {
                const index = parseInt(partNumber, 10);
                if (index >= 0 && index < subTotalScoreArr.length && index < sarr.length) {
                    return `${title.trim()}: (${sarr[index]}/${subTotalScoreArr[index]})`;
                }
                return match;
            });
        }
    </script>
</body>

</html>