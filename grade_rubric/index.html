<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
	<link rel="shortcut icon" href="#">
</head>
<body>
    <div id="container"></div>
    <div id="edit-box">
        <textarea id="edit-text"></textarea>
        <div id="edit-score-container">
            <label for="edit-score">Score</label>
            <input id="edit-score" type="number" />
        </div>
        <div id="edit-buttons">
            <button id="edit-cancel">Cancel</button>
            <button id="edit-save">Save</button>
        </div>
    </div>
    <div id="overlay"></div>

    <script>
	
	function readTextFile(file, callback) {
    var rawFile = new XMLHttpRequest();
    rawFile.overrideMimeType("application/json");
    rawFile.open("GET", file, true);
    rawFile.onreadystatechange = function() {
        if (rawFile.readyState === 4 && rawFile.status == "200") {
            callback(rawFile.responseText);
        }
    }
    rawFile.send(null);
}

//usage:
readTextFile("template.json", function(text){
    var data = JSON.parse(text);
    //console.log(data);
});
	
	
        let selectedItem = null;

        function editItem() {
            const editBox = document.getElementById('edit-box');
            const editText = document.getElementById('edit-text');
            const editScore = document.getElementById('edit-score');
            const overlay = document.getElementById('overlay');

            editText.value = selectedItem.innerText;
            editScore.value = selectedItem.getAttribute('score');
            editBox.style.visibility = 'visible';
            overlay.style.visibility = 'visible';
			
			
        }
        
        function renderProblem(container, problems) {
		let subTotal= 0;
		var arr = [];
		let subTotalDiv = document.createElement('div');
            for(let problem of problems) {
                const yes = problem.yes;
                const no = problem.no;
                const score = problem.point;

                const itemContainer = document.createElement('div');
                itemContainer.classList.add('item-container');

                const itemYes = document.createElement('div');
                itemYes.classList.add('item-yes');
                itemYes.classList.add('selected');
                itemYes.setAttribute('score', score);
                itemYes.innerText = yes;

                const itemNo = document.createElement('div');
                itemNo.classList.add('item-no');
                itemNo.setAttribute('score', score);
                itemNo.innerText = no;
				
				const itemScore = document.createElement('div');
                itemScore.classList.add('item-score');
                itemScore.innerHTML = score;
				itemScore.style.color = 'red';
                //itemScore.innerText = no;
				subTotal += parseInt(score);
				arr.push(score);

                itemYes.addEventListener('click', () => {
                    itemYes.classList.add('selected');
                    itemNo.classList.remove('selected');
                });

                itemYes.addEventListener('dblclick', function() {
                    selectedItem = this;
                    editItem();
					console.log(selectedItem);
                });

                itemNo.addEventListener('click', () => {
                    itemNo.classList.add('selected');
                    itemYes.classList.remove('selected');
                });

                itemNo.addEventListener('dblclick', function() {
                    selectedItem = this;
                    editItem();
                });

                itemContainer.appendChild(itemYes);
                itemContainer.appendChild(itemNo);
				itemContainer.appendChild(itemScore);

                
                container.appendChild(itemContainer);
            }
			subTotalDiv.innerHTML = subTotal;
			subTotalDiv.style.display = "flex";
			subTotalDiv.style.color = 'green';
			subTotalDiv.style.minHeight = "15px"; 
			//subTotalDiv.setAttribute("align", "left");
			subTotalDiv.setAttribute("text-align", "right");
			//subTotalDiv.setAttribute("margin", "0 auto");
			//subTotalDiv.setAttribute("display", "flex");
			subTotalDiv.style.marginBottom = "10px"; 
			subTotalDiv.style.float = "right";
			subTotalDiv.style.fontSize = "12px";
			subTotalDiv.style.padding = "5px";
			//subTotalDiv.style.position = "relative";
			//subTotalDiv.style.right = "0";
			//subTotalDiv.align = 'left';
			subTotalDiv.classList.add('sub-total-score');
			container.appendChild(subTotalDiv);
			
			console.log(arr, subTotal);
        }

        fetch('template.json').then(response => response.json()).then(data => {
            // Reder page
            console.log(data);
            const container = document.getElementById('container');
            const parts = Object.keys(data);
            for(let part of parts) {
                const partContainer = document.createElement('div');
                partContainer.classList.add('part-container');

                const partTitle = data[part].title;
                const partProblems = data[part].problems;

                const h3 = document.createElement('h3');
                h3.innerText = `${part}: ${partTitle}`;
                partContainer.appendChild(h3);

                if(partProblems.length > 1) {   
                    for(let i=0; i<partProblems.length; i++) {
                        const problemContainer = document.createElement('div');
                        problemContainer.classList.add('problem-container');
                    
                        const problemTitle = `Problem ${i+1}`;
                        const h4 = document.createElement('h4');
                        h4.innerText = problemTitle;
                        problemContainer.appendChild(h4);

                        const problemList = partProblems[i];
                        renderProblem(problemContainer, problemList);
                        partContainer.appendChild(problemContainer);
                    }
                } else {
                    const problemContainer = document.createElement('div');
                    problemContainer.classList.add('problem-container');
                    const problemList = partProblems[0];

                    renderProblem(problemContainer, problemList);
                    partContainer.appendChild(problemContainer);
                }

                container.appendChild(partContainer);
            }

            // Save button convert page to text file
            const saveButton = document.createElement('button');
            saveButton.classList.add('save-button');
            saveButton.innerText = 'Save';
			
			const textAreaDiv = document.createElement('div');
			var input = document.createElement("textarea");
				input.name = "post";
				input.maxLength = "5000";
				input.cols = "80";
				input.rows = "20";
				input.classList.add('item-textareabox');
			textAreaDiv.classList.add('item-textarea');
			textAreaDiv.appendChild(input);
			var inputTxt = document.createElement("input");
			inputTxt.type = "text";
			
            saveButton.addEventListener('click', () => {
                // Formating document
                let text = '';
                let score = 0;
                const parts = document.querySelectorAll('.part-container');
                parts.forEach(part => {
                    const title = part.querySelector('h3').innerText;
                    text += `${title}\n`;

                    const problems = part.querySelectorAll('.problem-container');
                    problems.forEach(problem => {
                        const problemTitle = problem.querySelector('h4');
                        if(problemTitle) {
                            text += `${problemTitle.innerText}: \n`;
                        }

                        const items = problem.querySelectorAll('.item-container');
                        items.forEach(item => {
						console.log(item);
                            const itemYes = item.querySelector('.item-yes');
                            const itemNo = item.querySelector('.item-no');

                            // Formating text for each question
                            if (itemYes.classList.contains('selected')) {
                                const _score = parseInt(itemYes.getAttribute('score'));
                                //text += `${_score}\t${itemYes.innerText}\n`;
								text += `\t${itemYes.innerText}\n`;
                                score += _score;
                            } else {
                                const _score = parseInt(itemNo.getAttribute('score'));
                                //text += `${_score}\t${itemNo.innerText}\n`;
								text += `\t${itemNo.innerText}\n`;
                                score += _score;
                            }
                        });

                        text += '\n';
                    });
                    
                });
				
				
                text += "Overall: \n\n" + input.value + '\n\n';

                text += `Total score: ${score}\n`;
                console.log(text);
				if (inputTxt.value == ''){
				    download('output.txt', text);
				}else{
					download(inputTxt.value+'.txt', text);
				}
            });
			container.appendChild(textAreaDiv);
			
			
			container.appendChild(inputTxt);
            container.appendChild(saveButton);
        })

        function download(filename, text) {
		
			
		
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('edit-save').addEventListener('click', () => {
                const editBox = document.getElementById('edit-box');
                const editText = document.getElementById('edit-text');
                const editScore = document.getElementById('edit-score');
                const overlay = document.getElementById('overlay');

                selectedItem.innerText = editText.value;
                selectedItem.setAttribute('score', editScore.value);
                editBox.style.visibility = 'hidden';
                overlay.style.visibility = 'hidden';
            });

            document.getElementById('edit-cancel').addEventListener('click', () => {
                const editBox = document.getElementById('edit-box');
                const overlay = document.getElementById('overlay');

                editBox.style.visibility = 'hidden';
                overlay.style.visibility = 'hidden';
            });
        });
    </script>
</body>
</html>